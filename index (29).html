<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#10b981" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob:; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https:; font-src 'self' data:; base-uri 'self'; form-action 'self'; frame-ancestors 'none'" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>ุงูุณุงุญู ููููุงุฏ ุงูุบุฐุงุฆูุฉ - ููุธููุฉ ุงููุจูุนุงุช</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root { color-scheme: light dark; }
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    .grid-auto-fill { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    .number-input { appearance: textfield; -moz-appearance: textfield; }
    .number-input::-webkit-outer-spin-button, .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    @media print { .no-print { display: none !important; } }

    /* Modern theme */
    :root{
      --brand:#10b981; /* emerald */
      --brand-2:#0ea5e9; /* sky */
      --card-bg: rgba(255,255,255,0.75);
      --card-border: rgba(15,23,42,0.08);
      --shadow: 0 8px 24px rgba(2,6,23,.08);
      --shadow-strong: 0 12px 36px rgba(2,6,23,.14);
    }
    body.modern-theme{
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(16,185,129,.20), transparent 60%),
        radial-gradient(1200px 600px at -10% 110%, rgba(14,165,233,.20), transparent 60%),
        linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
    }
    body.modern-theme header{
      backdrop-filter: saturate(1.2) blur(6px);
      background: linear-gradient(180deg, rgba(255,255,255,.85) 0%, rgba(255,255,255,.70) 100%) !important;
      box-shadow: 0 1px 0 rgba(15,23,42,.06);
    }
    body.modern-theme nav{
      background: rgba(248,250,252,.6) !important;
      backdrop-filter: blur(6px);
    }
    /* Modern cards (sections) */
    body.modern-theme .rounded-xl.border{
      background: var(--card-bg) !important;
      border-color: var(--card-border) !important;
      box-shadow: var(--shadow);
    }
    /* Buttons */
    body.modern-theme button{
      transition: transform .15s ease, box-shadow .2s ease, background-color .2s ease, color .2s ease, border-color .2s ease;
    }
    body.modern-theme button:hover{ transform: translateY(-1px); }
    body.modern-theme .bg-emerald-600{
      background-image: linear-gradient(135deg, var(--brand) 0%, #059669 100%) !important;
      box-shadow: 0 6px 14px rgba(16,185,129,.24);
    }
    body.modern-theme .bg-emerald-600:hover{ filter: brightness(1.05); }
    /* Tab buttons */
    body.modern-theme .tab-btn{
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.6);
      box-shadow: 0 2px 10px rgba(2,6,23,.06);
    }
    body.modern-theme .tab-btn.bg-emerald-600{
      color: white !important;
      border-color: transparent;
      box-shadow: 0 6px 16px rgba(16,185,129,.28);
    }
    /* Inputs */
    body.modern-theme input, body.modern-theme select, body.modern-theme textarea{
      background: rgba(255,255,255,.8);
      border-color: rgba(15,23,42,.12) !important;
      box-shadow: inset 0 1px 2px rgba(2,6,23,.04);
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    body.modern-theme input:focus, body.modern-theme select:focus, body.modern-theme textarea:focus{
      outline: none;
      border-color: var(--brand) !important;
      box-shadow: 0 0 0 4px rgba(16,185,129,.18);
      background: rgba(255,255,255,.95);
    }
    /* POS/Return product cards */
    body.modern-theme #pos-products button,
    body.modern-theme #ret-products button{
      background: rgba(255,255,255,.8) !important;
      border-color: rgba(15,23,42,.10) !important;
      box-shadow: 0 6px 16px rgba(2,6,23,.06);
    }
    body.modern-theme #pos-products button:hover,
    body.modern-theme #ret-products button:hover{
      border-color: var(--brand);
      box-shadow: var(--shadow-strong);
    }
    /* Tables */
    body.modern-theme table thead{
      background: linear-gradient(180deg, rgba(241,245,249,.9), rgba(226,232,240,.9)) !important;
    }
    body.modern-theme table th{
      color: #0f172a !important;
      font-weight: 700;
    }
    /* Badges and small pills */
    body.modern-theme #app-version{
      background: rgba(16,185,129,.12) !important;
      border-color: rgba(16,185,129,.28) !important;
      color: #065f46 !important;
    }
    /* Notifications count */
    body.modern-theme #noti-count{
      background: #f59e0b !important;
      color: white !important;
    }

    /* Futuristic 2030 Theme */
    body.futuristic-2030{
      --fx-primary:#22d3ee; /* cyan-400 */
      --fx-secondary:#a78bfa; /* violet-400 */
      --fx-accent:#34d399; /* emerald-400 */
      --fx-warn:#f59e0b; /* amber-500 */
      --fx-surface: rgba(255,255,255,0.08);
      --fx-border: rgba(148,163,184,0.22);
      --fx-shadow: 0 10px 30px rgba(2,6,23,.28), inset 0 1px 0 rgba(255,255,255,.06);
      --fx-glow: 0 0 0 0 rgba(34,211,238,.0);
      background:
        radial-gradient(1200px 600px at 85% -10%, rgba(34,211,238,.15), transparent 60%),
        radial-gradient(1000px 500px at 10% 110%, rgba(167,139,250,.18), transparent 60%),
        linear-gradient(135deg, #0f172a 0%, #0b1220 100%);
      color-scheme: dark;
      background-size: 120% 120%;
      animation: gradientShift 30s ease-in-out infinite;
    }
    @keyframes gradientShift{
      0%{ background-position: 0% 0% }
      50%{ background-position: 100% 50% }
      100%{ background-position: 0% 0% }
    }

    body.futuristic-2030 header{
      backdrop-filter: saturate(1.4) blur(10px);
      background: linear-gradient(180deg, rgba(15,23,42,.55) 0%, rgba(15,23,42,.35) 100%) !important;
      border-bottom: 1px solid rgba(148,163,184,.25) !important;
      box-shadow: 0 8px 24px rgba(2,6,23,.40);
    }
    body.futuristic-2030 nav{
      background: rgba(2,6,23,.35) !important;
      border-top: 1px solid rgba(148,163,184,.18) !important;
      backdrop-filter: blur(8px);
    }

    body.futuristic-2030 .rounded-xl.border{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04)) !important;
      border: 1px solid var(--fx-border) !important;
      box-shadow: var(--fx-shadow);
    }

    body.futuristic-2030 .tab-btn{
      border: 1px solid rgba(148,163,184,.28);
      background: linear-gradient(180deg, rgba(15,23,42,.6), rgba(15,23,42,.4));
      color: #cbd5e1;
      box-shadow: 0 6px 18px rgba(2,6,23,.35);
      transition: transform .15s ease, box-shadow .2s ease, background-color .2s ease, color .2s ease, border-color .2s ease;
    }
    body.futuristic-2030 .tab-btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(2,6,23,.45); }
    body.futuristic-2030 .tab-btn.bg-emerald-600{
      background-image: linear-gradient(135deg, var(--fx-primary) 0%, var(--fx-secondary) 100%) !important;
      color: white !important; border-color: transparent; box-shadow: 0 10px 28px rgba(34,211,238,.35);
    }

    body.futuristic-2030 button{
      transition: transform .15s ease, box-shadow .25s ease, filter .2s ease, background-color .2s ease, border-color .2s ease, color .2s ease;
    }
    body.futuristic-2030 button:hover{ transform: translateY(-1px); }
    body.futuristic-2030 .bg-emerald-600{
      background-image: linear-gradient(135deg, var(--fx-accent) 0%, #10b981 100%) !important;
      border: 1px solid rgba(16,185,129,.35) !important;
      box-shadow: 0 10px 26px rgba(16,185,129,.35), 0 0 0 0 rgba(16,185,129,.0);
    }
    body.futuristic-2030 .bg-emerald-600:hover{ filter: brightness(1.06); box-shadow: 0 16px 40px rgba(16,185,129,.45); }

    /* Inputs */
    body.futuristic-2030 input, body.futuristic-2030 select, body.futuristic-2030 textarea{
      background: rgba(15,23,42,.55);
      color: #e2e8f0;
      border-color: rgba(148,163,184,.35) !important;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    body.futuristic-2030 input::placeholder, body.futuristic-2030 textarea::placeholder{ color:#94a3b8 }
    body.futuristic-2030 input:focus, body.futuristic-2030 select:focus, body.futuristic-2030 textarea:focus{
      outline: none;
      border-color: var(--fx-primary) !important;
      box-shadow: 0 0 0 4px rgba(34,211,238,.20);
      background: rgba(15,23,42,.7);
    }

    /* POS/Return product cards */
    body.futuristic-2030 #pos-products button,
    body.futuristic-2030 #ret-products button{
      background: linear-gradient(180deg, rgba(15,23,42,.6), rgba(15,23,42,.45)) !important;
      border-color: rgba(148,163,184,.28) !important;
      box-shadow: 0 12px 28px rgba(2,6,23,.45);
      color: #e5e7eb;
    }
    body.futuristic-2030 #pos-products button:hover,
    body.futuristic-2030 #ret-products button:hover{
      border-color: var(--fx-primary);
      box-shadow: 0 22px 48px rgba(34,211,238,.22);
    }

    /* Tables */
    body.futuristic-2030 table thead{
      background: linear-gradient(180deg, rgba(30,41,59,.9), rgba(15,23,42,.9)) !important;
      color:#e2e8f0;
    }
    body.futuristic-2030 table th{ color:#e2e8f0 !important; font-weight:800 }

    /* Badges */
    body.futuristic-2030 #app-version{
      background: rgba(34,211,238,.14) !important;
      border-color: rgba(34,211,238,.34) !important;
      color: #0ea5e9 !important;
    }
    body.futuristic-2030 #noti-count{
      background: #22d3ee !important; color: #0b1220 !important;
    }

    /* Small polish */
    body.futuristic-2030 .text-slate-700{ color:#cbd5e1 !important }
    body.futuristic-2030 .text-slate-600{ color:#94a3b8 !important }
    body.futuristic-2030 .text-slate-500{ color:#94a3b8 !important }
    body.futuristic-2030 .bg-white{ background: rgba(255,255,255,.06) !important }

    /* Icon-only Navigation (disabled: restore icon+label) */
    header nav .tab-btn{ padding:0.5rem 0.75rem; border-radius:0.5rem; display:inline-flex; align-items:center; gap:0.4rem }
    header nav .tab-btn > span > span{ display:inline }
    header nav .tab-btn svg{ width:18px; height:18px }

    /* Floating Action Buttons */
    .fab{ position:fixed; bottom:20px; left:20px; z-index:60; }
    .fab .fab-main{ width:56px; height:56px; border-radius:9999px; background:#10b981; color:white; display:grid; place-items:center; font-size:24px; box-shadow:0 10px 20px rgba(16,185,129,.35); border:1px solid rgba(16,185,129,.35) }
    .fab .fab-list{ display:flex; flex-direction:column; gap:8px; margin-bottom:10px; transform:translateY(10px); opacity:.0; pointer-events:none; transition: all .2s ease; }
    .fab.open .fab-list{ transform:translateY(0); opacity:1; pointer-events:auto; }
    .fab .fab-item{ width:44px; height:44px; border-radius:9999px; display:grid; place-items:center; background:white; border:1px solid rgba(15,23,42,.12); color:#0f172a; box-shadow:0 6px 16px rgba(2,6,23,.10) }
    body.futuristic-2030 .fab .fab-main{ background-image: linear-gradient(135deg, #34d399, #10b981); border-color:rgba(16,185,129,.35) }
    body.futuristic-2030 .fab .fab-item{ background:rgba(15,23,42,.55); border-color:rgba(148,163,184,.35); color:#e2e8f0; box-shadow:0 12px 28px rgba(2,6,23,.45) }
    @media print{ .fab{ display:none !important } }

    /* Hide primary action buttons when using FAB mode */
    .hide-main #btn-clear-cart,
    .hide-main #btn-print-invoice,
    .hide-main #btn-save-invoice-pdf,
    .hide-main #btn-checkout,
    .hide-main #btn-clear-return,
    .hide-main #btn-process-return,
    .hide-main #btn-add-sample,
    .hide-main #btn-new-product,
    .hide-main #btn-new-customer,
    .hide-main #btn-new-supplier,
    .hide-main #btn-add-expense,
    .hide-main #btn-run-report,
    .hide-main #btn-export-csv,
    .hide-main #btn-print-report,
    .hide-main #btn-save-report-pdf,
    .hide-main #btn-print-invoices-products,
    .hide-main #btn-print-all-invoices,
    .hide-main #btn-print-transactions,
    .hide-main #btn-print-pays,
    .hide-main #btn-print-products,
    .hide-main #btn-db-test,
    .hide-main #btn-db-clear,
    .hide-main #btn-export-dash{ display:none !important }
    /* Home page as floating circular buttons */
    #home-grid{ gap:14px }
    #home-grid .home-btn{
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.95);
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
      border-radius: 9999px;
      aspect-ratio: 1 / 1;
      display: grid;
      place-items: center;
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    }
    #home-grid .home-btn:hover{ transform: translateY(-2px); box-shadow: 0 16px 36px rgba(2,6,23,.16); border-color: var(--brand) }
    #home-grid .home-btn > span{ display:grid; place-items:center; gap:6px }
    #home-grid .home-btn svg{ width:28px; height:28px }
    #home-grid .home-btn > span > span{ font-weight:800; }
    body.futuristic-2030 #home-grid .home-btn{ background: rgba(15,23,42,.55); border-color: rgba(148,163,184,.35); box-shadow: 0 12px 28px rgba(2,6,23,.45); color:#e2e8f0 }
    body.futuristic-2030 #home-grid .home-btn:hover{ border-color: var(--fx-primary); box-shadow: 0 22px 48px rgba(34,211,238,.22) }

    /* Role-based visibility and restrictions */
    body.role-employee.lock-settings #btn-save-settings{ display:none !important }
    body.role-employee.hide-export #btn-export,
    body.role-employee.hide-export #btn-export-dash,
    body.role-employee.hide-export #btn-export-csv,
    body.role-employee.hide-export #btn-save-report-pdf{ display:none !important }
    body.role-employee.hide-deletes button.del{ display:none !important }
    body.role-employee.hide-products-manage #btn-add-sample,
    body.role-employee.hide-products-manage #btn-new-product,
    body.role-employee.hide-products-manage button.stock,
    body.role-employee.hide-products-manage button.edit{ display:none !important }
    body.role-employee.hide-db .db-card{ display:none !important }
    body.role-employee.hide-reports .tab-btn[data-tab="reports"],
    body.role-employee.hide-reports #tab-reports,
    body.role-employee.hide-reports #home-grid .home-btn[data-tab="reports"]{ display:none !important }
    body.role-employee.hide-dashboard .tab-btn[data-tab="dashboard"],
    body.role-employee.hide-dashboard #tab-dashboard,
    body.role-employee.hide-dashboard #home-grid .home-btn[data-tab="dashboard"]{ display:none !important }
    body.role-employee.hide-suppliers .tab-btn[data-tab="suppliers"],
    body.role-employee.hide-suppliers #tab-suppliers,
    body.role-employee.hide-suppliers #home-grid .home-btn[data-tab="suppliers"]{ display:none !important }

    /* Header role badge */
    #role-badge{ font-weight:700 }

    /* Disable floating action buttons entirely */
    .fab{ display:none !important }

    /* Restore primary action buttons in place */
    .hide-main #btn-clear-cart,
    .hide-main #btn-print-invoice,
    .hide-main #btn-save-invoice-pdf,
    .hide-main #btn-checkout,
    .hide-main #btn-clear-return,
    .hide-main #btn-process-return,
    .hide-main #btn-add-sample,
    .hide-main #btn-new-product,
    .hide-main #btn-new-customer,
    .hide-main #btn-new-supplier,
    .hide-main #btn-add-expense,
    .hide-main #btn-run-report,
    .hide-main #btn-export-csv,
    .hide-main #btn-print-report,
    .hide-main #btn-save-report-pdf,
    .hide-main #btn-print-invoices-products,
    .hide-main #btn-print-all-invoices,
    .hide-main #btn-print-transactions,
    .hide-main #btn-print-pays,
    .hide-main #btn-print-products,
    .hide-main #btn-db-test,
    .hide-main #btn-db-clear,
    .hide-main #btn-export-dash{ display:inline-flex !important }

    /* 3D Mode (site-wide) */
    body.three-d{ perspective: 1200px; perspective-origin: 50% 20%; }
    .tilt{ transform-style: preserve-3d; will-change: transform; transition: transform .18s ease, box-shadow .25s ease; }
    .tilt-strong{ transition: transform .14s ease, box-shadow .28s ease; }
    .tilt .tilt-layer{ transform: translateZ(16px); }
    .tilt:hover{ box-shadow: 0 16px 36px rgba(2,6,23,.16) }
    body.futuristic-2030 .tilt:hover{ box-shadow: 0 22px 48px rgba(34,211,238,.22) }
    @media (prefers-reduced-motion: reduce){ .tilt{ transition:none } }
    /* ุฅุฎูุงุก ุดุฑูุท ุงูุชุจููุจ ุงูุนููู ูุงูุฅุจูุงุก ุนูู ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ ููุท */
    header nav{ display:none !important; }
    @media print{ .tilt{ transform:none !important } }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 modern-theme">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Floating Action Buttons -->
    <div id="fab" class="fab no-print hidden">
      <div class="fab-list" id="fab-list"></div>
      <button id="fab-main" class="fab-main" title="ุฅุฌุฑุงุกุงุช"><span>๏ผ</span></button>
    </div>

    <!-- Header -->
    <header class="bg-white sticky top-0 z-40 shadow-sm border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-emerald-600 text-white grid place-items-center text-xl font-bold">ุณ</div>
          <div>
            <div class="flex items-center gap-2 flex-wrap">
              <h1 class="text-lg sm:text-2xl font-extrabold tracking-tight">ุงูุณุงุญู ููููุงุฏ ุงูุบุฐุงุฆูุฉ</h1>
              <span id="app-version" class="px-2 py-0.5 text-xs rounded-md border border-slate-300 bg-slate-50 text-slate-600">v2.1.3</span>
            </div>
            <p class="text-xs sm:text-sm text-slate-500">ููุธููุฉ ุงููุจูุนุงุช ูุฅุฏุงุฑุฉ ุงููุฎุฒูู - ุงูุนููุฉ: ุฏููุงุฑ ููุจู (ุฏ.ู)</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="role-badge" class="hidden sm:inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700 text-xs border border-slate-200" title="ุงูุฏูุฑ">ูุฏูุฑ</span>
          <button id="btn-logout" class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-rose-50 text-rose-700 text-sm border border-rose-200" title="ุชุณุฌูู ุงูุฎุฑูุฌ">ุฎุฑูุฌ</button>
          <button id="btn-back-home" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-slate-100 text-slate-700 text-sm border border-slate-200 hidden" title="ุงูุฑุฌูุน ููุฑุฆูุณูุฉ">โฌ๏ธ <span class="hidden sm:inline">ุฑุฌูุน</span></button>
          <button id="btn-install" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-emerald-50 text-emerald-700 text-sm border border-emerald-200 hidden" title="ุชุซุจูุช ุงูุชุทุจูู ุนูู ุงูููุจููุชุฑ">โฌ๏ธ <span class="hidden sm:inline">ุชุซุจูุช</span></button>
          <button id="btn-toggle-theme" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-slate-100 text-slate-700 text-sm border border-slate-200" title="ุชุจุฏูู ุงููุธูุฑ">๐จ <span class="hidden sm:inline">ุงููุธูุฑ</span></button>
          <button id="btn-open-notifications" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-amber-50 text-amber-700 text-sm border border-amber-200" title="ุงูุฅุดุนุงุฑุงุช">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 006 14h12a1 1 0 00.707-1.707L18 11.586V8a6 6 0 00-6-6zm0 20a3 3 0 003-3H9a3 3 0 003 3z"/></svg>
            <span>ุฅุดุนุงุฑุงุช</span>
            <span id="noti-count" class="px-1.5 rounded bg-amber-600 text-white text-xs">0</span>
          </button>
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-lg bg-emerald-50 text-emerald-700 text-sm border border-emerald-200">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M2.25 13.5a8.25 8.25 0 1116.5 0 8.25 8.25 0 01-16.5 0zM21 21l-3.197-3.197"/></svg>
            <span id="header-now">--:--</span>
          </span>
          <span id="net-status" class="hidden sm:inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700 text-xs border border-slate-200" title="ุญุงูุฉ ุงูุงุชุตุงู">ุบูุฑ ูุชุตู</span>
        </div>
      </div>
      <!-- Nav -->
      <nav class="bg-slate-50/60 border-t border-slate-200/70">
        <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8 overflow-x-auto scrollbar-thin">
          <ul class="flex gap-2 py-2 text-sm font-medium">
            <li><button data-tab="pos" class="tab-btn px-3 py-2 rounded-md bg-emerald-600 text-white" title="ููุทุฉ ุงูุจูุน">ููุทุฉ ุงูุจูุน</button></li>
            <li><button data-tab="returns" class="tab-btn px-3 py-2 rounded-md hover:bg-slate-200" title="ููุทุฉ ุงูุชุฑุฌูุน">ููุทุฉ ุงูุชุฑุฌูุน</button></li>
            <li><button data-tab="inventory" class="tab-btn px-3 py-2 rounded-md hover:bg-slate-200" title="ุงููุฎุฒูู">ุงููุฎุฒูู</button></li>
            <li><button data-tab="customers" class="tab-btn px-3 py-2 rounded-md hover:bg-slate-200" title="ุงูุนููุงุก">ุงูุนููุงุก</button></li>
            <li><button data-tab="suppliers" class="tab-btn px-3 py-2 rounded-md hover:bg-slate-200" title="ุงูููุฑุฏูู">ุงูููุฑุฏูู</button></li>
            <li><button data-tab="expenses" class="tab-btn px-3 py-2 rounded-md hover:bg-slate-200" title="ุงููุตุฑููุงุช">ุงููุตุฑููุงุช</button></li>
            <li><button data-tab="reports" class="tab-btn px-3 py-2 rounded-md hover:bg-slate-200" title="ุงูุชูุงุฑูุฑ">ุงูุชูุงุฑูุฑ</button></li>
            <li><button data-tab="dashboard" class="tab-btn px-3 py-2 rounded-md hover:bg-slate-200" title="ููุญุฉ ุงูุชุญูู">ููุญุฉ ุงูุชุญูู</button></li>
          </ul>
        </div>
      </nav>
    </header>

    <!-- Main -->
    <main class="flex-1">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Home Tab -->
        <section id="tab-home" class="tab">
          <div class="bg-white border border-slate-200 rounded-xl p-6">
            <h2 class="text-xl font-extrabold text-slate-800 mb-4">ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</h2>
            <p class="text-sm text-slate-600 mb-4">ุงุฎุชุฑ ูุณููุง ููุงูุชูุงู:</p>
            <div id="home-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <button class="home-btn px-4 py-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-400 hover:shadow-sm" data-tab="pos" data-icon="pos" data-label="ููุทุฉ ุงูุจูุน">ููุทุฉ ุงูุจูุน</button>
              <button class="home-btn px-4 py-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-400 hover:shadow-sm" data-tab="returns" data-icon="returns" data-label="ููุทุฉ ุงูุชุฑุฌูุน">ููุทุฉ ุงูุชุฑุฌูุน</button>
              <button class="home-btn px-4 py-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-400 hover:shadow-sm" data-tab="inventory" data-icon="inventory" data-label="ุงููุฎุฒูู">ุงููุฎุฒูู</button>
              <button class="home-btn px-4 py-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-400 hover:shadow-sm" data-tab="customers" data-icon="customers" data-label="ุงูุนููุงุก">ุงูุนููุงุก</button>
              <button class="home-btn px-4 py-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-400 hover:shadow-sm" data-tab="suppliers" data-icon="suppliers" data-label="ุงูููุฑุฏูู">ุงูููุฑุฏูู</button>
              <button class="home-btn px-4 py-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-400 hover:shadow-sm" data-tab="expenses" data-icon="expenses" data-label="ุงููุตุฑููุงุช">ุงููุตุฑููุงุช</button>
              <button class="home-btn px-4 py-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-400 hover:shadow-sm" data-tab="reports" data-icon="reports" data-label="ุงูุชูุงุฑูุฑ">ุงูุชูุงุฑูุฑ</button>
              <button class="home-btn px-4 py-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-400 hover:shadow-sm" data-tab="dashboard" data-icon="dashboard" data-label="ููุญุฉ ุงูุชุญูู">ููุญุฉ ุงูุชุญูู</button>
            </div>
          </div>
        </section>

        <!-- POS Tab -->
        <section id="tab-pos" class="tab hidden">
          <div class="grid grid-cols-12 gap-4">
            <!-- Sidebar filters -->
            <aside class="col-span-12 lg:col-span-2 bg-white border border-slate-200 rounded-xl p-3 h-fit sticky top-24">
              <h3 class="font-bold text-slate-700 mb-2">ุงูุชุตูููุงุช</h3>
              <div class="flex flex-wrap gap-2">
                <button class="cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="all">ุงููู</button>
                <button class="cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ูุดุฑูุจุงุช">ูุดุฑูุจุงุช</button>
                <button class="cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ุนุตุงุฆุฑ">ุนุตุงุฆุฑ</button>
                <button class="cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ุดูููุงุชุฉ">ุดูููุงุชุฉ</button>
                <button class="cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ููุงุฏ ุบุฐุงุฆูุฉ">ููุงุฏ ุบุฐุงุฆูุฉ</button>
                <button class="cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ุจููููุงุช">ุจููููุงุช</button>
                <button class="cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ููุชุฌุงุช ุตุบูุฑุฉ">ููุชุฌุงุช ุตุบูุฑุฉ</button>
              </div>
              <div class="mt-4">
                <label class="text-sm text-slate-500">ุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ</label>
                <input id="pos-search" type="search" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="ุงุจุญุซ..." />
              </div>
            </aside>

            <!-- Products -->
            <section class="col-span-12 lg:col-span-7">
              <div class="bg-white border border-slate-200 rounded-xl p-4 min-h-[420px]">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-bold text-slate-700">ุงูููุชุฌุงุช</h3>
                  <span id="pos-current-cat" class="text-sm text-slate-500">ุงุฎุชุฑ ุชุตููููุง ูุนุฑุถ ุงูููุชุฌุงุช</span>
                </div>
                <div id="pos-small-strip" class="mb-3 overflow-x-auto whitespace-nowrap hidden"></div>
                <div id="pos-products" class="grid grid-auto-fill gap-3">
                  <div class="col-span-full text-center text-slate-400 py-16">
                    ุงุฎุชุฑ ุชุตููููุง ูู ุงููููู ูุนุฑุถ ุงูููุชุฌุงุช ููุง
                  </div>
                </div>
              </div>
            </section>

            <!-- Cart -->
            <aside class="col-span-12 lg:col-span-3">
              <div class="bg-white border border-slate-200 rounded-xl p-4 flex flex-col gap-3">
                <h3 class="font-bold text-slate-700">ุงูุณูุฉ</h3>
                <div id="cart-items" class="space-y-2 max-h-[320px] overflow-auto pr-1"></div>
                <div class="text-sm text-slate-600 flex flex-col gap-1">
                  <div class="flex justify-between"><span>ุนุฏุฏ ุงูุฃุตูุงู:</span><span id="cart-count">0</span></div>
                  <div class="flex justify-between"><span>ุงูุฅุฌูุงูู ูุจู ุงูุฎุตู:</span><span id="cart-subtotal">0.00 ุฏ.ู</span></div>
                  <div class="flex items-center justify-between gap-2">
                    <label class="text-sm">ุงูุฎุตู:</label>
                    <input id="cart-discount-input" type="number" min="0" step="0.01" class="w-32 rounded-lg border border-slate-300 px-2 py-1 text-right number-input" value="0" />
                  </div>
                  <div class="flex justify-between font-bold"><span>ุงูุฅุฌูุงูู:</span><span id="cart-total">0.00 ุฏ.ู</span></div>
                </div>
                <div class="border-t border-slate-200 pt-3">
                  <label class="block text-sm text-slate-600 mb-1">ุทุฑููุฉ ุงูุฏูุน</label>
                  <div class="flex flex-wrap gap-2">
                    <label class="inline-flex items-center gap-1"><input type="radio" name="pay" value="cash" class="pay-method" checked><span>ููุฏูุง</span></label>
                    <label class="inline-flex items-center gap-1"><input type="radio" name="pay" value="card" class="pay-method"><span>ุจุทุงูุฉ</span></label>
                    <label class="inline-flex items-center gap-1"><input type="radio" name="pay" value="credit" class="pay-method"><span>ุนูู ุงูุญุณุงุจ</span></label>
                  </div>
                  <div id="card-area" class="hidden mt-2">
                    <label class="text-sm text-slate-600">ุฑูู ุงูุชูููุถ</label>
                    <input id="card-auth" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ุฃุฏุฎู ุฑูู ุงูุชูููุถ" />
                  </div>
                  <div id="credit-area" class="hidden mt-2 space-y-2">
                    <label class="text-sm text-slate-600">ุงุณู ุงูุนููู</label>
                    <div class="flex gap-2">
                      <input id="credit-customer-name" class="flex-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="ุงูุชุจ ุงุณู ุงูุนููู ุฃู ุงุฎุชุฑ" />
                      <select id="credit-customer-select" class="rounded-lg border border-slate-300 px-2 py-2 min-w-[140px]"></select>
                    </div>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button id="btn-clear-cart" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุฅูุฑุงุบ</button>
                  <button id="btn-print-invoice" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุทุจุงุนุฉ ูุงุชูุฑุฉ</button>
                  <button id="btn-save-invoice-pdf" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุญูุธ PDF</button>
                  <button id="btn-checkout" class="flex-1 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ุชุญุตูู</button>
                </div>
              </div>
            </aside>
          </div>
        </section>

        <!-- Returns Tab -->
        <section id="tab-returns" class="tab hidden">
          <div class="grid grid-cols-12 gap-4">
            <aside class="col-span-12 lg:col-span-2 bg-white border border-slate-200 rounded-xl p-3 h-fit sticky top-24">
              <h3 class="font-bold text-slate-700 mb-2">ุงูุชุฑุฌูุน - ุงูุชุตูููุงุช</h3>
              <div class="flex flex-wrap gap-2">
                <button class="ret-cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="all">ุงููู</button>
                <button class="ret-cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ูุดุฑูุจุงุช">ูุดุฑูุจุงุช</button>
                <button class="ret-cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ุนุตุงุฆุฑ">ุนุตุงุฆุฑ</button>
                <button class="ret-cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ุดูููุงุชุฉ">ุดูููุงุชุฉ</button>
                <button class="ret-cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ููุงุฏ ุบุฐุงุฆูุฉ">ููุงุฏ ุบุฐุงุฆูุฉ</button>
                <button class="ret-cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ุจููููุงุช">ุจููููุงุช</button>
                <button class="ret-cat-btn px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200" data-cat="ููุชุฌุงุช ุตุบูุฑุฉ">ููุชุฌุงุช ุตุบูุฑุฉ</button>
              </div>
              <div class="mt-4">
                <label class="text-sm text-slate-500">ุฅุฏุฎุงู ุณุฑูุน (ุจุงุฑููุฏ/ููุฏ)</label>
                <input id="return-code" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ุงูุชุจ ุงูููุฏ ูุงุถุบุท ุฅุฏุฎุงู" />
              </div>
            </aside>

            <section class="col-span-12 lg:col-span-7">
              <div class="bg-white border border-slate-200 rounded-xl p-4 min-h-[420px]">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-bold text-slate-700">ุงูููุชุฌุงุช ููุชุฑุฌูุน</h3>
                  <span id="ret-current-cat" class="text-sm text-slate-500">ุงุฎุชุฑ ุชุตููููุง</span>
                </div>
                <div id="ret-small-strip" class="mb-3 overflow-x-auto whitespace-nowrap hidden"></div>
                <div id="ret-products" class="grid grid-auto-fill gap-3">
                  <div class="col-span-full text-center text-slate-400 py-16">
                    ุงุฎุชุฑ ุชุตููููุง ูุนุฑุถ ุงูููุชุฌุงุช ููุง ููุชุฑุฌูุน
                  </div>
                </div>
              </div>
            </section>

            <aside class="col-span-12 lg:col-span-3">
              <div class="bg-white border border-slate-200 rounded-xl p-4 flex flex-col gap-3">
                <h3 class="font-bold text-slate-700">ุณูุฉ ุงูุชุฑุฌูุน</h3>
                <div id="return-items" class="space-y-2 max-h-[320px] overflow-auto pr-1"></div>
                <div class="text-sm text-slate-600 flex flex-col gap-1">
                  <div class="flex justify-between"><span>ุนุฏุฏ ุงูุฃุตูุงู:</span><span id="return-count">0</span></div>
                  <div class="flex justify-between"><span>ูููุฉ ุงูุชุฑุฌูุน:</span><span id="return-total">0.00 ุฏ.ู</span></div>
                </div>
                <div class="border-t border-slate-200 pt-3">
                  <label class="block text-sm text-slate-600 mb-1">ุทุฑููุฉ ุงูุงุณุชุฑุฌุงุน</label>
                  <div class="flex flex-wrap gap-2">
                    <label class="inline-flex items-center gap-1"><input type="radio" name="retpay" value="cash" class="ret-pay-method" checked><span>ููุฏูุง</span></label>
                    <label class="inline-flex items-center gap-1"><input type="radio" name="retpay" value="card" class="ret-pay-method"><span>ุจุทุงูุฉ</span></label>
                    <label class="inline-flex items-center gap-1"><input type="radio" name="retpay" value="credit" class="ret-pay-method"><span>ุนูู ุงูุญุณุงุจ</span></label>
                  </div>
                  <div id="ret-card-area" class="hidden mt-2">
                    <label class="text-sm text-slate-600">ุฑูู ุงูุชูููุถ</label>
                    <input id="ret-card-auth" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ุฃุฏุฎู ุฑูู ุงูุชูููุถ" />
                  </div>
                  <div id="ret-credit-area" class="hidden mt-2 space-y-2">
                    <label class="text-sm text-slate-600">ุงุณู ุงูุนููู</label>
                    <div class="flex gap-2">
                      <input id="ret-credit-customer-name" class="flex-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="ุงูุชุจ ุงุณู ุงูุนููู ุฃู ุงุฎุชุฑ" />
                      <select id="ret-credit-customer-select" class="rounded-lg border border-slate-300 px-2 py-2 min-w-[140px]"></select>
                    </div>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button id="btn-clear-return" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุฅูุฑุงุบ</button>
                  <button id="btn-process-return" class="flex-1 px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">ุชุฑุฌูุน</button>
                </div>
              </div>
            </aside>
          </div>
        </section>

        <!-- Inventory Tab -->
        <section id="tab-inventory" class="tab hidden">
          <div class="bg-white border border-slate-200 rounded-xl p-4">
            <div class="flex flex-wrap items-end gap-2">
              <div class="flex-1 min-w-[220px]">
                <label class="text-sm text-slate-600">ุจุญุซ</label>
                <input id="inv-search" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ุงุณู/ููุฏ" />
              </div>
              <div>
                <label class="text-sm text-slate-600">ุงูุชุตููู</label>
                <select id="inv-cat-filter" class="w-full rounded-lg border border-slate-300 px-3 py-2 min-w-[160px]">
                  <option value="all">ุงููู</option>
                  <option>ูุดุฑูุจุงุช</option>
                  <option>ุนุตุงุฆุฑ</option>
                  <option>ุดูููุงุชุฉ</option>
                  <option>ููุงุฏ ุบุฐุงุฆูุฉ</option>
                  <option>ุจููููุงุช</option>
                  <option>ููุชุฌุงุช ุตุบูุฑุฉ</option>
                </select>
              </div>
              <div class="ms-auto flex gap-2">
                <button id="btn-add-sample" class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุฅุถุงูุฉ ุนููุงุช</button>
                <button id="btn-new-product" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ููุชุฌ ุฌุฏูุฏ</button>
              </div>
            </div>
            <div class="mt-4 overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-50 text-slate-600">
                  <tr>
                    <th class="text-right p-2">ุงูููุฏ</th>
                    <th class="text-right p-2">ุงูุงุณู</th>
                    <th class="text-right p-2">ุงูุชุตููู</th>
                    <th class="text-right p-2">ุณุนุฑ ุงูุจูุน</th>
                    <th class="text-right p-2">ุณุนุฑ ุงูุชูููุฉ</th>
                    <th class="text-right p-2">ูุณุจุฉ ุงูุฑุจุญ</th>
                    <th class="text-right p-2">ุงููููุฉ</th>
                    <th class="text-right p-2">ุชุงุฑูุฎ ุงูุฅูุชุงุฌ</th>
                    <th class="text-right p-2">ุงูุชูุงุก ุงูุตูุงุญูุฉ</th>
                    <th class="text-right p-2">ููุงุญุธุฉ</th>
                    <th class="text-right p-2">ุฅุฌุฑุงุกุงุช</th>
                  </tr>
                </thead>
                <tbody id="inv-tbody" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
            <div class="flex items-center justify-between mt-4 text-xs text-slate-500">
              <div>ุฅุฌูุงูู ุงูููุชุฌุงุช: <span id="inv-total-count">0</span></div>
              <div class="flex gap-2">
                <button id="btn-export" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">ูุณุฎ ุงุญุชูุงุทู</button>
                <button id="btn-import" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">ุงุณุชุนุงุฏุฉ</button>
                <input id="import-file" type="file" accept="application/json" class="hidden" />
              </div>
            </div>
          </div>
        </section>

        <!-- Customers Tab -->
        <section id="tab-customers" class="tab hidden">
          <div class="bg-white border border-slate-200 rounded-xl p-4">
            <div class="flex items-end gap-2">
              <div class="flex-1">
                <label class="text-sm text-slate-600">ุจุญุซ ุนู ุนููู</label>
                <input id="cust-search" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ุงุณู/ูุงุชู" />
              </div>
              <button id="btn-new-customer" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ุนููู ุฌุฏูุฏ</button>
            </div>
            <div class="mt-4 overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-50 text-slate-600">
                  <tr>
                    <th class="text-right p-2">ุงูุงุณู</th>
                    <th class="text-right p-2">ุงููุงุชู</th>
                    <th class="text-right p-2">ุงูุฑุตูุฏ (ุฏููู)</th>
                    <th class="text-right p-2">ุขุฎุฑ ุชุญุฏูุซ</th>
                    <th class="text-right p-2">ุฅุฌุฑุงุกุงุช</th>
                  </tr>
                </thead>
                <tbody id="cust-tbody" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Suppliers Tab -->
        <section id="tab-suppliers" class="tab hidden">
          <div class="bg-white border border-slate-200 rounded-xl p-4">
            <div class="flex items-end gap-2">
              <div class="flex-1">
                <label class="text-sm text-slate-600">ุจุญุซ ุนู ููุฑุฏ</label>
                <input id="sup-search" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ุงุณู/ูุงุชู/ุดุฑูุฉ" />
              </div>
              <button id="btn-new-supplier" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ููุฑุฏ ุฌุฏูุฏ</button>
            </div>
            <div class="mt-4 overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-50 text-slate-600">
                  <tr>
                    <th class="text-right p-2">ุงูุงุณู</th>
                    <th class="text-right p-2">ุงููุงุชู</th>
                    <th class="text-right p-2">ุงูุดุฑูุฉ</th>
                    <th class="text-right p-2">ุงูุฑุตูุฏ (ููููุฑุฏ)</th>
                    <th class="text-right p-2">ุขุฎุฑ ุชุญุฏูุซ</th>
                    <th class="text-right p-2">ุฅุฌุฑุงุกุงุช</th>
                  </tr>
                </thead>
                <tbody id="sup-tbody" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Expenses Tab -->
        <section id="tab-expenses" class="tab hidden">
          <div class="grid md:grid-cols-3 gap-4">
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-2">ุฅุถุงูุฉ ูุตุฑูู</h3>
              <div class="space-y-2">
                <div>
                  <label class="text-sm text-slate-600">ุงููุจูุบ (ุฏ.ู)</label>
                  <input id="exp-amount" type="number" min="0" step="0.01" class="w-full rounded-lg border border-slate-300 px-3 py-2 number-input" placeholder="0.00" />
                </div>
                <div>
                  <label class="text-sm text-slate-600">ููุงุญุธุงุช</label>
                  <textarea id="exp-note" class="w-full rounded-lg border border-slate-300 px-3 py-2" rows="3" placeholder="ุณุจุจ/ุชูุงุตูู"></textarea>
                </div>
                <div class="text-xs text-slate-500">ุงูุชุงุฑูุฎ ูุงูููุช ูุชู ุญูุธููุง ุชููุงุฆููุง</div>
                <button id="btn-add-expense" class="w-full px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ุญูุธ</button>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4 md:col-span-2">
              <h3 class="font-bold text-slate-700 mb-2">ูุงุฆูุฉ ุงููุตุฑููุงุช</h3>
              <div class="overflow-auto max-h-[420px]">
                <table class="min-w-full text-sm">
                  <thead class="bg-slate-50 text-slate-600">
                    <tr>
                      <th class="text-right p-2">ุงูุชุงุฑูุฎ</th>
                      <th class="text-right p-2">ุงููุจูุบ</th>
                      <th class="text-right p-2">ุงูููุงุญุธุงุช</th>
                      <th class="text-right p-2">ุญุฐู</th>
                    </tr>
                  </thead>
                  <tbody id="exp-tbody" class="divide-y divide-slate-100"></tbody>
                </table>
              </div>
              <div class="text-sm text-slate-600 mt-3">ุฅุฌูุงูู ุงููุตุฑููุงุช: <span id="exp-total">0.00 ุฏ.ู</span></div>
            </div>
          </div>
        </section>

        <!-- Reports Tab -->
        <section id="tab-reports" class="tab hidden">
          <div class="bg-white border border-slate-200 rounded-xl p-4">
            <div class="flex flex-wrap items-end gap-3">
              <div>
                <label class="text-sm text-slate-600">ููุน ุงูุชูุฑูุฑ</label>
                <select id="rep-type" class="w-full rounded-lg border border-slate-300 px-3 py-2 min-w-[140px]">
                  <option value="daily">ูููู</option>
                  <option value="monthly">ุดูุฑู</option>
                  <option value="yearly">ุณููู</option>
                </select>
              </div>
              <div id="rep-date-wrap">
                <label class="text-sm text-slate-600">ุงูุชุงุฑูุฎ</label>
                <input id="rep-date" type="date" class="w-full rounded-lg border border-slate-300 px-3 py-2" />
              </div>
              <div id="rep-month-wrap" class="hidden">
                <label class="text-sm text-slate-600">ุงูุดูุฑ</label>
                <input id="rep-month" type="month" class="w-full rounded-lg border border-slate-300 px-3 py-2" />
              </div>
              <div id="rep-year-wrap" class="hidden">
                <label class="text-sm text-slate-600">ุงูุณูุฉ</label>
                <input id="rep-year" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2" min="2000" max="2100" step="1" />
              </div>
              <div class="ms-auto flex flex-wrap gap-2">
                <button id="btn-run-report" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ุนุฑุถ ุงูุชูุฑูุฑ</button>
                <button id="btn-export-csv" class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุชุตุฏูุฑ CSV</button>
                <button id="btn-print-report" class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุทุจุงุนุฉ</button>
                <button id="btn-save-report-pdf" class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุญูุธ PDF</button>
                <button id="btn-print-invoices-products" class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุทุจุงุนุฉ ุงูููุชุฌุงุช ููู ูุงุชูุฑุฉ</button>
                <button id="btn-print-all-invoices" class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุทุจุงุนุฉ ูู ุงูููุงุชูุฑ</button>
              </div>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-3 mt-4">
              <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-xs text-slate-500">ุฅุฌูุงูู ุงููุจูุนุงุช (ุจุนุฏ ุงูุชุฑุฌูุน)</div>
                <div id="rep-sales" class="text-2xl font-extrabold mt-1">0.00 ุฏ.ู</div>
              </div>
              <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-xs text-slate-500">ุชูููุฉ ุงูุจุถุงุนุฉ</div>
                <div id="rep-cost" class="text-2xl font-extrabold mt-1">0.00 ุฏ.ู</div>
              </div>
              <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-xs text-slate-500">ุฅุฌูุงูู ุงููุตุฑููุงุช</div>
                <div id="rep-exp" class="text-2xl font-extrabold mt-1">0.00 ุฏ.ู</div>
              </div>
              <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-xs text-slate-500">ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ</div>
                <div id="rep-profit" class="text-2xl font-extrabold mt-1">0.00 ุฏ.ู</div>
              </div>
              <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-xs text-slate-500">ูููุฉ ุงูููุชุฌุงุช (ูุจู ุงูุฎุตู)</div>
                <div id="rep-gross" class="text-2xl font-extrabold mt-1">0.00 ุฏ.ู</div>
              </div>
              <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-xs text-slate-500">ุฏูู ุงูุนููุงุก (ุญุงูู)</div>
                <div id="rep-cust-debt" class="text-2xl font-extrabold mt-1">0.00 ุฏ.ู</div>
              </div>
              <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                <div class="text-xs text-slate-500">ุฏูู ุงูููุฑุฏูู (ุญุงูู)</div>
                <div id="rep-sup-debt" class="text-2xl font-extrabold mt-1">0.00 ุฏ.ู</div>
              </div>
            </div>

            <div class="flex flex-wrap gap-2 mt-4">
              <button id="btn-print-transactions" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">ุทุจุงุนุฉ ุงููุนุงููุงุช</button>
              <button id="btn-print-pays" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">ุทุจุงุนุฉ ุทุฑู ุงูุฏูุน</button>
              <button id="btn-print-products" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">ุทุจุงุนุฉ ุงูููุชุฌุงุช</button>
              <button id="btn-print-suppliers" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">ุทุจุงุนุฉ ุงูููุฑุฏูู</button>
            </div>

            <div class="grid lg:grid-cols-3 gap-4 mt-3">
              <div class="lg:col-span-2">
                <h4 class="font-bold text-slate-700 mb-2">ุงููุนุงููุงุช</h4>
                <div class="overflow-auto max-h-[360px]">
                  <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 text-slate-600">
                      <tr>
                        <th class="text-right p-2">ุงูููุน</th>
                        <th class="text-right p-2">ุงูุชุงุฑูุฎ ูุงูููุช</th>
                        <th class="text-right p-2">ุทุฑููุฉ ุงูุฏูุน</th>
                        <th class="text-right p-2">ุงูุฅุฌูุงูู</th>
                        <th class="text-right p-2">ุงูุฃุตูุงู</th>
                        <th class="text-right p-2">ุงูุฑุจุญ</th>
                        <th class="text-right p-2">ุฑูู ุงููุงุชูุฑุฉ</th>
                        <th class="text-right p-2">ูุงุชูุฑุฉ</th>
                      </tr>
                    </thead>
                    <tbody id="rep-tbody" class="divide-y divide-slate-100"></tbody>
                  </table>
                </div>
              </div>
              <div>
                <h4 class="font-bold text-slate-700 mb-2">ุชูุตูู ุทุฑู ุงูุฏูุน</h4>
                <ul id="rep-pays" class="space-y-1 text-sm text-slate-700"></ul>
                <h4 class="font-bold text-slate-700 mt-4 mb-2">ุชูุตูู ุงูููุชุฌุงุช</h4>
                <ul id="rep-products" class="space-y-1 text-sm text-slate-700 max-h-[200px] overflow-auto"></ul>
                <h4 class="font-bold text-slate-700 mt-4 mb-2">ููุฎุต ุงูุดุฑูุงุก</h4>
                <ul id="rep-partners" class="space-y-1 text-sm text-slate-700 max-h-[200px] overflow-auto"></ul>
                <h4 class="font-bold text-slate-700 mt-4 mb-2">ููุฎุต ุงูููุฑุฏูู</h4>
                <ul id="rep-suppliers-summary" class="space-y-1 text-sm text-slate-700 max-h-[200px] overflow-auto"></ul>
                <h4 class="font-bold text-slate-700 mt-4 mb-2">ุนูููุงุช ุงูููุฑุฏูู</h4>
                <ul id="rep-suppliers" class="space-y-1 text-sm text-slate-700 max-h-[200px] overflow-auto"></ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Dashboard/Settings Tab -->
        <section id="tab-dashboard" class="tab hidden">
          <div class="grid lg:grid-cols-3 gap-4">
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-2">ููุฎุต ุงูููู</h3>
              <ul class="text-sm text-slate-700 space-y-1">
                <li>ูุจูุนุงุช ุงูููู: <span id="dash-today-sales">0.00 ุฏ.ู</span></li>
                <li>ูุตุฑููุงุช ุงูููู: <span id="dash-today-exp">0.00 ุฏ.ู</span></li>
                <li>ุงูุฑุจุญ ุงูุชูุฏูุฑู ุงูููู: <span id="dash-today-profit">0.00 ุฏ.ู</span></li>
              </ul>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-2">ุงููุฎุฒูู ูุงูุชูุจููุงุช</h3>
              <ul id="dash-low-stock" class="text-sm text-slate-700 space-y-1 max-h-[220px] overflow-auto"></ul>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-2">ุงูุฅุดุนุงุฑุงุช</h3>
              <ul id="dash-notifications" class="text-sm text-slate-700 space-y-1 max-h-[220px] overflow-auto"></ul>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-3">ุงูุฅุนุฏุงุฏุงุช</h3>
              <div class="space-y-2 text-sm">
                <div>
                  <label class="text-slate-600">ุงุณู ุงููุญู</label>
                  <input id="set-store-name" class="w-full rounded-lg border border-slate-300 px-3 py-2" />
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="text-slate-600">ุฑูุฒ ุงูุนููุฉ</label>
                    <input id="set-curr-symbol" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ุฏ.ู" />
                  </div>
                  <div>
                    <label class="text-slate-600">ุงูุนููุฉ</label>
                    <input id="set-currency" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="LYD" />
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <input id="set-negative-stock" type="checkbox" class="rounded border-slate-300">
                  <label for="set-negative-stock" class="text-slate-700">ุงูุณูุงุญ ุจุงูุจูุน ุนูุฏ ููุงุฐ ุงููุฎุฒูู</label>
                </div>
                <div class="flex items-center gap-2">
                  <input id="set-enable-3d" type="checkbox" class="rounded border-slate-300">
                  <label for="set-enable-3d" class="text-slate-700">ุชูุนูู ูุงุฌูุฉ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ (3D)</label>
                </div>
                <div>
                  <label class="text-slate-600">ุงูุดุฑูุงุก (ูู ุณุทุฑ ุดุฑูู)</label>
                  <textarea id="set-partners" class="w-full rounded-lg border border-slate-300 px-3 py-2" rows="3" placeholder="ูุซุงู: ุดุฑูู 1\nุดุฑูู 2"></textarea>
                </div>
                <button id="btn-save-settings" class="w-full px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4 db-card">
              <h3 class="font-bold text-slate-700 mb-3">ูุงุนุฏุฉ ุงูุจูุงูุงุช</h3>
              <ul class="text-sm text-slate-700 space-y-1">
                <li>ุงูุฅุตุฏุงุฑ: <span id="app-version-dash">v2.1.3</span></li>
                <li>ุงูููุน: IndexedDB</li>
                <li>ุงุณู ุงููุงุนุฏุฉ: <span id="db-name">sahel-pos-db</span></li>
                <li>ุงููุฌููุนุฉ: <span id="db-store">state</span></li>
                <li>ุงูุญุงูุฉ: <span id="db-status">--</span></li>
                <li>ุขุฎุฑ ุงุฎุชุจุงุฑ: <span id="db-last-test">--</span></li>
              </ul>
              <div class="flex flex-col sm:flex-row gap-2 mt-3">
                <button id="btn-db-test" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุงุฎุชุจุงุฑ ุงููุงุนุฏุฉ</button>
                <button id="btn-db-clear" class="flex-1 px-3 py-2 rounded-lg border border-rose-300 text-rose-700 hover:bg-rose-50">ูุณุญ ุงููุงุนุฏุฉ</button>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-3">ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช</h3>
              <div class="space-y-2 text-sm">
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="text-slate-600">ูููุฉ ูุฑูุฑ ุงููุฏูุฑ</label>
                    <input id="set-admin-pass" type="password" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="โขโขโขโขโขโข" />
                  </div>
                  <div>
                    <label class="text-slate-600">ุงูููุธููู (ูู ุณุทุฑ: ุงูุงุณู,ูููุฉ ุงููุฑูุฑ)</label>
                    <textarea id="set-employees" class="w-full rounded-lg border border-slate-300 px-3 py-2" rows="3" placeholder="ูุซุงู: ุฃุญูุฏ,1234&#10;ูุงุทูุฉ,4321"></textarea>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <label class="inline-flex items-center gap-2"><input id="perm-hide-settings" type="checkbox" class="rounded border-slate-300" /><span>ุฅุฎูุงุก ุฅุนุฏุงุฏุงุช ุงููุธุงู ุนู ุงูููุธููู</span></label>
                  <label class="inline-flex items-center gap-2"><input id="perm-hide-export" type="checkbox" class="rounded border-slate-300" /><span>ุฅุฎูุงุก ุงููุณุฎ/ุงูุชุตุฏูุฑ ุนู ุงูููุธููู</span></label>
                  <label class="inline-flex items-center gap-2"><input id="perm-hide-deletes" type="checkbox" class="rounded border-slate-300" /><span>ููุน ุงูุญุฐู ุนู ุงูููุธููู</span></label>
                  <label class="inline-flex items-center gap-2"><input id="perm-hide-products-manage" type="checkbox" class="rounded border-slate-300" /><span>ููุน ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช ุนู ุงูููุธููู</span></label>
                  <label class="inline-flex items-center gap-2"><input id="perm-hide-reports" type="checkbox" class="rounded border-slate-300" /><span>ุฅุฎูุงุก ุงูุชูุงุฑูุฑ ุนู ุงูููุธููู</span></label>
                  <label class="inline-flex items-center gap-2"><input id="perm-hide-dashboard" type="checkbox" class="rounded border-slate-300" /><span>ุฅุฎูุงุก ููุญุฉ ุงูุชุญูู ุนู ุงูููุธููู</span></label>
                  <label class="inline-flex items-center gap-2"><input id="perm-hide-suppliers" type="checkbox" class="rounded border-slate-300" /><span>ุฅุฎูุงุก ุงูููุฑุฏูู ุนู ุงูููุธููู</span></label>
                </div>
                <div class="flex gap-2">
                  <button id="btn-save-auth" class="flex-1 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ุญูุธ ุงูุตูุงุญูุงุช</button>
                  <button id="btn-switch-user" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุชุจุฏูู ุงููุณุชุฎุฏู</button>
                </div>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-3">ุงููุฒุงููุฉ</h3>
              <div class="space-y-2 text-sm">
                <div>
                  <label class="text-slate-600">ุนููุงู Webhook/Email API</label>
                  <input id="set-sync-endpoint" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="https://example.com/webhook" />
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="inline-flex items-center gap-2"><input id="set-auto-sync" type="checkbox" class="rounded border-slate-300" /><span>ูุฒุงููุฉ ุชููุงุฆูุฉ</span></label>
                  </div>
                  <div>
                    <label class="text-slate-600">ุงููุงุตู (ุฏูุงุฆู)</label>
                    <input id="set-sync-interval" type="number" min="1" step="1" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="15" />
                  </div>
                </div>
                <div>
                  <label class="text-slate-600">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ูููุฒุงููุฉ ุงูุณุญุงุจูุฉ)</label>
                  <input id="set-sync-email" type="email" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="you@example.com" />
                </div>
                <div class="text-xs text-slate-500">ุขุฎุฑ ูุฒุงููุฉ: <span id="sync-last">ูุง ููุฌุฏ</span> โข ุงูุญุงูุฉ: <span id="sync-status">-</span></div>
                <div class="flex gap-2">
                  <button id="btn-sync-now" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ูุฒุงููุฉ ุงูุขู</button>
                </div>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-3">ูุณุฎ ุงุญุชูุงุทู ูุงุณุชุนุงุฏุฉ</h3>
              <p class="text-sm text-slate-600">ูู ุจุชุตุฏูุฑ ูุณุฎุฉ ูุงููุฉ ูู ุจูุงูุงุช ุงูููุธููุฉ ุฃู ุงุณุชุนุงุฏุชูุง.</p>
              <div class="flex flex-col sm:flex-row gap-2 mt-3">
                <button id="btn-export-dash" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ูุณุฎ ุงุญุชูุงุทู ูุงูู</button>
                <button id="btn-import-dash" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุงุณุชุนุงุฏุฉ</button>
                <input id="import-file-dash" type="file" accept="application/json" class="hidden" />
              </div>
              <div class="mt-3 text-xs text-slate-500">ูุณุฎ ุงุญุชูุงุทู ุชููุงุฆู: <span id="auto-backup-status">ุบูุฑ ููุนู</span></div>
              <div class="mt-2 flex items-center gap-2 text-sm">
                <input id="set-auto-backup" type="checkbox" class="rounded border-slate-300" />
                <label for="set-auto-backup" class="text-slate-700">ุชูุนูู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู</label>
              </div>
              <div class="mt-2">
                <label class="text-sm text-slate-600">ุงููุงุตู (ุณุงุนุงุช)</label>
                <input id="set-backup-interval" type="number" min="1" step="1" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="24" />
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <h3 class="font-bold text-slate-700 mb-3">ุชุญููู ุฅูู ุชุทุจูู APK</h3>
              <p class="text-sm text-slate-600">ูููู ุชุญููู ุงูููุธููุฉ ุฅูู ุชุทุจูู ุฃูุฏุฑููุฏ ุจุณูููุฉ ุนุจุฑ ุฃุฏูุงุช ุฎุงุฑุฌูุฉ.</p>
              <button id="btn-apk-help" class="w-full px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุฅุฑุดุงุฏุงุช ุฅูุดุงุก APK</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-200 py-4 text-center text-xs text-slate-500">
      ูุชู ุญูุธ ุงูุจูุงูุงุช ูุญูููุง ุนุจุฑ IndexedDB ููุณุฎุฉ ุงุญุชูุงุทูุฉ ูู localStorage ุนูู ูุฐุง ุงูุฌูุงุฒ. ููุตู ุจุฃุฎุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฏูุฑูุฉ. โข ุงูุฅุตุฏุงุฑ: <span id="footer-version">v2.1.3</span>
    </footer>
  </div>

  <!-- Modal (generic small) -->
  <div id="modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-md rounded-xl shadow-xl border border-slate-200 p-4">
      <h3 id="modal-title" class="font-bold text-slate-800 mb-2">ุนููุงู</h3>
      <div id="modal-body" class="space-y-3"></div>
      <div class="flex gap-2 mt-4">
        <button id="modal-cancel" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุฅูุบุงุก</button>
        <button id="modal-ok" class="flex-1 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ููุงูู</button>
      </div>
    </div>
  </div>

  <!-- App Lock Overlay -->
  <div id="lock-overlay" class="fixed inset-0 z-[70] hidden">
    <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
    <div class="relative max-w-sm mx-auto mt-24 bg-white rounded-xl shadow-xl border border-slate-200 p-5">
      <h3 class="font-extrabold text-slate-800 text-lg mb-2">ููู ุงูุชุทุจูู</h3>
      <p id="lock-desc" class="text-sm text-slate-600 mb-3">ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ููุชุญ ุงูุชุทุจูู</p>
      <input id="lock-pass" type="password" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="โขโขโขโขโขโข" />
      <div class="flex gap-2 mt-3">
        <button id="lock-cancel" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">ุฎุฑูุฌ</button>
        <button id="lock-ok" class="flex-1 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ุฏุฎูู</button>
      </div>
      <div id="lock-msg" class="text-xs text-rose-600 mt-2"></div>
      <div class="mt-2 text-xs text-slate-500 text-center">
        <button id="lock-forgot" class="underline hover:text-emerald-700">ูู ูุณูุช ูููุฉ ุงููุฑูุฑุ</button>
      </div>
    </div>
  </div>

  <script>
    // App version
    const APP_VERSION = '2.1.3';

    // Disable eval for extra safety
    try { window.eval = () => { throw new Error('Eval blocked'); }; } catch(e){}

    // Utilities
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const fmt = (n) => (Number(n)||0).toFixed(2);
    const nowISO = () => new Date().toISOString();
    const fmtDate = (iso) => new Intl.DateTimeFormat('ar-LY', { dateStyle: 'short', timeStyle: 'short' }).format(new Date(iso));
    const fileSafe = (name) => String(name||'').trim().replace(/\s+/g,'-').replace(/[^\u0600-\u06FF\w\-]+/g,'').replace(/\-+/g,'-').replace(/^\-+|\-+$/g,'') || 'sahel';
    const tsFile = () => { const d=new Date(); const p=(n)=> String(n).padStart(2,'0'); return d.getFullYear()+''+p(d.getMonth()+1)+''+p(d.getDate())+'-'+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds()); };
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b=> b.toString(16).padStart(2,'0')).join('');
    }
    // Instance ID and dynamic DB name (per-install database)
    const INSTANCE_ID = (function(){
      try{
        let id = localStorage.getItem('sahel-instance-id');
        if (!id){ id = Math.random().toString(36).slice(2,10); localStorage.setItem('sahel-instance-id', id); }
        return id;
      }catch(e){ return 'default'; }
    })();
    function getDbName(){ return 'sahel-pos-db-' + INSTANCE_ID; }

    // Database (IndexedDB) - ุชุฎุฒูู ุงูุญุงูุฉ ูู ุณุฌู ูุงุญุฏ ุฏุงุฎู ูุฎุฒู state
    const db = {
      db: null,
      open(){
        return new Promise((resolve, reject)=>{
          const req = indexedDB.open(getDbName(), 1);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains('state')) db.createObjectStore('state', { keyPath: 'id' });
          };
          req.onsuccess = () => { this.db = req.result; resolve(); };
          req.onerror = () => reject(req.error);
        });
      },
      async getState(){
        try {
          if (!this.db) await this.open();
          return await new Promise((res, rej)=>{
            const tx = this.db.transaction('state','readonly');
            const st = tx.objectStore('state');
            const r = st.get('root');
            r.onsuccess = () => res(r.result?.data || null);
            r.onerror = () => rej(r.error);
          });
        } catch(e){ return null; }
      },
      async setState(data){
        if (!this.db) await this.open();
        return await new Promise((res, rej)=>{
          const tx = this.db.transaction('state','readwrite');
          const st = tx.objectStore('state');
          st.put({ id:'root', data });
          tx.oncomplete = () => res();
          tx.onerror = () => rej(tx.error);
        });
      }
    };

    // State
    const defaultState = () => ({
      settings: {
        storeName: 'ุงูุณุงุญู ููููุงุฏ ุงูุบุฐุงุฆูุฉ', currency: 'LYD', currencySymbol: 'ุฏ.ู', enable3D: true, allowNegativeStock: false, lowStockLevel: 5,
        adminPassword: '0000', employeePin: '1234', appLockHash: null,
        permissions: { hideSettings:false, hideExport:false, hideDeletes:false, hideProductsManage:false, hideReports:false, hideDashboard:false, hideSuppliers:false },
        autoSync: { enabled:false, endpoint:'', email:'', intervalMin:15, last:null, status:'' },
        autoBackup: { enabled:true, intervalHours:24, last:null },
        partners: [], // ูุงุฆูุฉ ุฃุณูุงุก ุงูุดุฑูุงุก (ุงุฎุชูุงุฑู)
        employees: [] // ูุงุฆูุฉ ุงูููุธููู (ุงุณู + ูููุฉ ูุฑูุฑ)
      },
      products: [],
      sales: [], // {id, number, type:'sale'|'return',items:[{productId,code,name,category,qty,price,total,cost}], paymentMethod:'cash'|'card'|'credit', customerId, customerName, date, totals}
      expenses: [], // {id,amount,note,date}
      customers: [], // {id,name,phone,balance,updatedAt,transactions:[{id,type:'sale'|'payment'|'return',amount,date,note,ref}]}
      suppliers: [], // {id,name,phone,company,note,balance,updatedAt,transactions:[{id,type:'purchase'|'payment',amount,date,note}]}
      meta: { lastDbTest: null, invoiceSeq: 1, currentUser: { role:'admin' }, onboarded: null }
    });

    const store = {
      key: 'sahel-pos-v1',
      state: null,
      async load(){
        try {
          // ุญุงูู ุงูุชุญููู ูู IndexedDB
          const dbState = await db.getState();
          if (dbState) this.state = dbState; else {
            const raw = localStorage.getItem(this.key);
            this.state = raw ? JSON.parse(raw) : defaultState();
          }
        } catch (e) {
          console.error('Load state error', e);
          const raw = localStorage.getItem(this.key);
          this.state = raw ? JSON.parse(raw) : defaultState();
        }
        // Ensure required fields
        const def = defaultState();
        this.state.settings = Object.assign({}, def.settings, this.state.settings||{});
        this.state.settings.permissions = Object.assign({}, def.settings.permissions, this.state.settings.permissions||{});
        this.state.settings.autoSync = Object.assign({}, def.settings.autoSync, this.state.settings.autoSync||{});
        this.state.settings.autoBackup = Object.assign({}, def.settings.autoBackup, this.state.settings.autoBackup||{});
        this.state.settings.partners ||= [];
        this.state.settings.employees ||= [];
        this.state.products ||= [];
        this.state.sales ||= [];
        this.state.expenses ||= [];
        this.state.customers ||= [];
        this.state.suppliers ||= [];
        this.state.meta = Object.assign({}, def.meta, this.state.meta||{});
      },
      async save(){
        try { await db.setState(this.state); } catch(e){ console.warn('IndexedDB save failed', e); }
        localStorage.setItem(this.key, JSON.stringify(this.state));
        refreshHeader();
        try { if (typeof updateDash === 'function') updateDash(); } catch(e){}
        try { if (typeof lastReport !== 'undefined' && lastReport) runReport(); } catch(e){}
      }
    };

    // Header clock
    function refreshHeader(){
      const {settings} = store.state;
      document.title = settings.storeName + ' - ููุธููุฉ ุงููุจูุนุงุช';
      const dt = new Date();
      $('#header-now').textContent = new Intl.DateTimeFormat('ar-LY', { dateStyle: 'medium', timeStyle: 'short' }).format(dt);
      // Update online/offline indicator
      const ns = document.getElementById('net-status');
      if (ns){
        const online = navigator.onLine;
        ns.textContent = online ? 'ูุชุตู' : 'ุบูุฑ ูุชุตู';
        ns.className = (online
          ? 'hidden sm:inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 text-xs border border-emerald-200'
          : 'hidden sm:inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-rose-50 text-rose-700 text-xs border border-rose-200');
      }
    }
    setInterval(refreshHeader, 1000);
    window.addEventListener('online', refreshHeader);
    window.addEventListener('offline', refreshHeader);

    // Tabs
    function showTab(name){
      // ููุน ุงูููุธู ูู ุงูุฏุฎูู ุฅูู ุชุจููุจุงุช ูุญุฌูุจุฉ ุญุณุจ ุตูุงุญูุงุช ุงููุฏูุฑ
      const user = store.state.meta?.currentUser || { role:'admin' };
      const perms = store.state.settings?.permissions || {};
      if (user.role === 'employee'){
        if (name === 'reports' && perms.hideReports){ alert('ุงูุชูุงุฑูุฑ ุบูุฑ ูุชุงุญุฉ ููููุธู'); return; }
        if (name === 'dashboard' && perms.hideDashboard){ alert('ููุญุฉ ุงูุชุญูู ุบูุฑ ูุชุงุญุฉ ููููุธู'); return; }
        if (name === 'suppliers' && perms.hideSuppliers){ alert('ุงูููุฑุฏูู ุบูุฑ ูุชุงุญูู ููููุธู'); return; }
      }
      $$('.tab').forEach(el=> el.classList.add('hidden'));
      const target = $(`#tab-${name}`);
      if (target) target.classList.remove('hidden');
      $$('.tab-btn').forEach(b=>{
        if (b.dataset.tab===name) b.classList.add('bg-emerald-600','text-white');
        else b.classList.remove('bg-emerald-600','text-white');
      });
      // Back button visibility: show when not on home
      const backBtn = document.getElementById('btn-back-home');
      if (backBtn) backBtn.classList.toggle('hidden', name==='home');
      buildFabForTab(name);
    }

    // Products helpers
    const categories = ['ูุดุฑูุจุงุช','ุนุตุงุฆุฑ','ุดูููุงุชุฉ','ููุงุฏ ุบุฐุงุฆูุฉ','ุจููููุงุช','ููุชุฌุงุช ุตุบูุฑุฉ'];
    function newId(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,9); }

    function findProductByCode(code){
      code = String(code||'').trim();
      if (!code) return null;
      return store.state.products.find(p => String(p.code).toLowerCase()===code.toLowerCase());
    }

    function addSampleProducts(){
      const samples = [
        { code:'1001', name:'ูุงุก 0.5 ูุชุฑ', category:'ูุดุฑูุจุงุช', price:1.50, cost:1.00, stock:50 },
        { code:'1002', name:'ุดุงู ุฃุฎุถุฑ', category:'ูุดุฑูุจุงุช', price:4.00, cost:3.20, stock:30 },
        { code:'2001', name:'ุนุตูุฑ ุจุฑุชูุงู', category:'ุนุตุงุฆุฑ', price:3.50, cost:2.50, stock:40 },
        { code:'3001', name:'ุดูููุงุชุฉ ุจุงูุญููุจ', category:'ุดูููุงุชุฉ', price:5.00, cost:3.80, stock:25 },
        { code:'4001', name:'ููุฑููุฉ 500ุบ', category:'ููุงุฏ ุบุฐุงุฆูุฉ', price:3.20, cost:2.20, stock:60 },
        { code:'4002', name:'ุณูุฑ 1ูุบ', category:'ููุงุฏ ุบุฐุงุฆูุฉ', price:3.80, cost:3.00, stock:70 },
        { code:'5001', name:'ููู ุจูุฏู (ุญุณุจ ุงูุณุนุฑ)', category:'ุจููููุงุช', price:10.00, cost:8.50, stock:null, priceOnly:true },
        { code:'5002', name:'ุนุฏุณ ุฃุญูุฑ (ุญุณุจ ุงูุณุนุฑ)', category:'ุจููููุงุช', price:12.00, cost:9.50, stock:null, priceOnly:true },
        { code:'6001', name:'ูุณุชูุฉ', category:'ููุชุฌุงุช ุตุบูุฑุฉ', price:0.50, cost:0.30, stock:200 },
        { code:'6002', name:'ูุตุงุตุฉ', category:'ููุชุฌุงุช ุตุบูุฑุฉ', price:0.75, cost:0.45, stock:150 }
      ];
      // Avoid duplicate codes
      for (const s of samples){
        if (!store.state.products.some(p=>p.code===s.code)){
          store.state.products.push({ id:newId('p'), prodDate:null, expDate:null, ...s });
        }
      }
      store.save();
      renderInventory();
      renderPOSProducts();
      renderReturnProducts();
      updateDash();
    }

    // POS state
    let posFilter = { cat: null, q:'' };
    let cart = [];// {productId,code,name,category,qty,price,total,cost, priceOnly}
    let cartDiscount = 0; // ุฎุตู ุนูู ุงูุณูุฉ ุจุงููุงูู

    // Returns state
    let retFilter = { cat: null };
    let retCart = [];

    function currency(n){ return fmt(n) + ' ' + store.state.settings.currencySymbol; }
    function payLabel(method){ return method==='cash'?'ููุฏูุง':method==='card'?'ุจุทุงูุฉ':'ุนูู ุงูุญุณุงุจ'; }

    // Small products quick strips
    function smallItems(){ return store.state.products.filter(p=> p.category==='ููุชุฌุงุช ุตุบูุฑุฉ'); }
    function buildSmallButtons(wrapId, addFn){
      const wrap = document.getElementById(wrapId); if (!wrap) return;
      const items = smallItems();
      if (items.length===0){ wrap.classList.add('hidden'); wrap.innerHTML=''; return; }
      wrap.classList.remove('hidden');
      wrap.innerHTML = '<span class="text-xs text-slate-500 inline-block mr-2">ุงูููุชุฌุงุช ุงูุตุบูุฑุฉ:</span>';
      items.forEach(p=>{
        const disabled = (!store.state.settings.allowNegativeStock && !p.priceOnly && (p.stock||0)<=0);
        const btn = document.createElement('button');
        btn.className = 'inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-full border border-slate-200 bg-white mr-2 mb-2 hover:border-emerald-400 hover:shadow-sm disabled:opacity-50 disabled:cursor-not-allowed';
        btn.disabled = disabled;
        btn.title = p.name + ' โข ' + currency(p.price);
        btn.textContent = p.name;
        btn.addEventListener('click', ()=> addFn(p));
        wrap.appendChild(btn);
      });
    }
    function renderPosSmallStrip(){ buildSmallButtons('pos-small-strip', addToCart); }
    function renderRetSmallStrip(){ buildSmallButtons('ret-small-strip', addToReturn); }

    function renderPOSProducts(){
      renderPosSmallStrip();
      const wrap = $('#pos-products');
      const q = ($('#pos-search').value||'').trim().toLowerCase();
      const cat = posFilter.cat;
      const list = store.state.products.filter(p=>{
        const okCat = !cat || cat==='all' ? true : p.category===cat;
        const okQ = !q || p.name.toLowerCase().includes(q) || String(p.code).includes(q);
        return okCat && okQ;
      });
      wrap.innerHTML = '';
      if (!cat){
        wrap.innerHTML = '<div class="col-span-full text-center text-slate-400 py-16">ุงุฎุชุฑ ุชุตููููุง ูู ุงููููู ูุนุฑุถ ุงูููุชุฌุงุช ููุง</div>';
        return;
      }
      if (list.length===0){
        wrap.innerHTML = '<div class="col-span-full text-center text-slate-400 py-16">ูุง ุชูุฌุฏ ููุชุฌุงุช ูุทุงุจูุฉ</div>';
        return;
      }
      const makeCard = (p)=>{
        const stockTxt = p.priceOnly ? 'ููุจุงุน ุจุงูุณุนุฑ' : ((p.stock ?? 0)+' ูุชุงุญ');
        const disabled = (!store.state.settings.allowNegativeStock && !p.priceOnly && (p.stock||0)<=0);
        const card = document.createElement('button');
        card.className = 'tilt text-right rounded-lg border border-slate-200 hover:border-emerald-400 hover:shadow-sm p-3 bg-white disabled:opacity-50 disabled:cursor-not-allowed';
        card.disabled = disabled;
        card.innerHTML = `
          <div class="font-bold text-slate-800 line-clamp-1">${p.name}</div>
          <div class="text-xs text-slate-500">${p.category} โข ููุฏ: ${p.code}</div>
          <div class="mt-2 flex items-center justify-between">
            <div class="text-emerald-700 font-bold">${currency(p.price)}</div>
            <div class="text-xs text-slate-500">${stockTxt}</div>
          </div>`;
        card.addEventListener('click', ()=> addToCart(p));
        return card;
      };
      if (cat==='all'){
        // Group by category with separators
        for (const c of categories){
          const items = list.filter(p=> p.category===c);
          if (items.length===0) continue;
          const sep = document.createElement('div');
          sep.className = 'col-span-full flex items-center gap-3 my-1';
          sep.innerHTML = `<div class="flex-1 h-px bg-slate-200"></div><div class="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded">${c}</div><div class="flex-1 h-px bg-slate-200"></div>`;
          wrap.appendChild(sep);
          for (const p of items){ wrap.appendChild(makeCard(p)); }
        }
        return;
      }
      for (const p of list){ wrap.appendChild(makeCard(p)); }
    }

    function renderReturnProducts(){
      renderRetSmallStrip();
      const wrap = $('#ret-products');
      const cat = retFilter.cat;
      const list = store.state.products.filter(p=> !cat || cat==='all' ? true : p.category===cat);
      wrap.innerHTML = '';
      if (!cat){
        wrap.innerHTML = '<div class="col-span-full text-center text-slate-400 py-16">ุงุฎุชุฑ ุชุตููููุง ูุนุฑุถ ุงูููุชุฌุงุช ููุง ููุชุฑุฌูุน</div>';
        return;
      }
      if (list.length===0){
        wrap.innerHTML = '<div class="col-span-full text-center text-slate-400 py-16">ูุง ุชูุฌุฏ ููุชุฌุงุช</div>';
        return;
      }
      const makeCard = (p)=>{
        const card = document.createElement('button');
        card.className = 'tilt text-right rounded-lg border border-slate-200 hover:border-rose-400 hover:shadow-sm p-3 bg-white';
        card.innerHTML = `
          <div class="font-bold text-slate-800 line-clamp-1">${p.name}</div>
          <div class="text-xs text-slate-500">${p.category} โข ููุฏ: ${p.code}</div>
          <div class="mt-2 flex items-center justify-between">
            <div class="text-rose-700 font-bold">${currency(p.price)}</div>
            <div class="text-xs text-slate-500">${p.priceOnly ? 'ููุจุงุน ุจุงูุณุนุฑ' : 'ูุชููุฑ'}</div>
          </div>`;
        card.addEventListener('click', ()=> addToReturn(p));
        return card;
      };
      if (cat==='all'){
        for (const c of categories){
          const items = list.filter(p=> p.category===c);
          if (items.length===0) continue;
          const sep = document.createElement('div');
          sep.className = 'col-span-full flex items-center gap-3 my-1';
          sep.innerHTML = `<div class="flex-1 h-px bg-slate-200"></div><div class="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded">${c}</div><div class="flex-1 h-px bg-slate-200"></div>`;
          wrap.appendChild(sep);
          for (const p of items){ wrap.appendChild(makeCard(p)); }
        }
        return;
      }
      for (const p of list){ wrap.appendChild(makeCard(p)); }
    }

    function addToCart(p){
      if (p.priceOnly){
        // ask for price
        promptModal('ุฅุฏุฎุงู ูููุฉ ุงูุจูุฏ (ุจููููุงุช)', `ุฃุฏุฎู ูููุฉ ุงูุจูุน ููุฐุง ุงูุจูุฏ: ${p.name}`, { fields:[{id:'price',label:'ุงููุจูุบ (ุฏ.ู)',type:'number',step:'0.01',min:'0',value:fmt(p.price)}] })
          .then(data=>{
            if (!data) return; const price = Number(data.price||0);
            if (!(price>0)) return;
            cart.push({ productId:p.id, code:p.code, name:p.name, category:p.category, qty:1, price:price, total:price, cost:Number(p.cost||0), priceOnly:true });
            renderCart();
          });
      } else {
        // increase quantity or add
        const existing = cart.find(i=>i.productId===p.id && !i.priceOnly);
        const canAdd = store.state.settings.allowNegativeStock || (Number(p.stock||0) > (existing? existing.qty : 0));
        if (!canAdd){ alert('ูุง ูููู ุฅุถุงูุฉ ุงููุฒูุฏุ ุงููุฎุฒูู ุบูุฑ ูุงูู'); return; }
        if (existing){ existing.qty += 1; existing.total = existing.qty * existing.price; }
        else cart.push({ productId:p.id, code:p.code, name:p.name, category:p.category, qty:1, price:Number(p.price||0), total:Number(p.price||0), cost:Number(p.cost||0), priceOnly:false });
        renderCart();
      }
    }

    function addToReturn(p){
      if (p.priceOnly){
        promptModal('ุชุฑุฌูุน (ุจููููุงุช)', `ุฃุฏุฎู ูููุฉ ุงูุชุฑุฌูุน ููุฐุง ุงูุจูุฏ: ${p.name}`, { fields:[{id:'price',label:'ุงููุจูุบ (ุฏ.ู)',type:'number',step:'0.01',min:'0',value:fmt(p.price)}] })
          .then(data=>{ if (!data) return; const price = Number(data.price||0); if (!(price>0)) return; retCart.push({ productId:p.id, code:p.code, name:p.name, category:p.category, qty:1, price:price, total:price, cost:Number(p.cost||0), priceOnly:true }); renderRetCart(); });
      } else {
        const existing = retCart.find(i=>i.productId===p.id && !i.priceOnly);
        if (existing){ existing.qty += 1; existing.total = existing.qty * existing.price; }
        else retCart.push({ productId:p.id, code:p.code, name:p.name, category:p.category, qty:1, price:Number(p.price||0), total:Number(p.price||0), cost:Number(p.cost||0), priceOnly:false });
        renderRetCart();
      }
    }

    function renderCart(){
      const wrap = $('#cart-items');
      wrap.innerHTML = '';
      let subtotal = 0; let count = 0;
      for (const item of cart){
        subtotal += Number(item.total||0); count += 1;
        const row = document.createElement('div');
        row.className = 'border border-slate-200 rounded-lg p-2 text-sm';
        row.innerHTML = `
          <div class="flex justify-between items-center gap-2">
            <div>
              <div class="font-bold text-slate-800">${item.name}</div>
              <div class="text-xs text-slate-500">ููุฏ: ${item.code} โข ${item.priceOnly ? 'ุจูุฏ ุจุงูุณุนุฑ' : 'ูููุฉ'}</div>
            </div>
            <button class="text-rose-600 hover:text-rose-700" title="ุญุฐู">โ</button>
          </div>
          <div class="mt-2 grid grid-cols-3 gap-2 items-center">
            <div>
              ${item.priceOnly ? '<div class="text-xs text-slate-500 mb-1">ุงููุจูุบ (ุฏ.ู)</div>' : '<div class="text-xs text-slate-500 mb-1">ุงููููุฉ</div>'}
              ${item.priceOnly ? `<input class="i-price w-full rounded-lg border border-slate-300 px-2 py-1 number-input" type="number" min="0" step="0.01" value="${fmt(item.price)}">` : `<input class="i-qty w-full rounded-lg border border-slate-300 px-2 py-1 number-input" type="number" min="1" step="1" value="${item.qty}">`}
            </div>
            <div>
              <div class="text-xs text-slate-500 mb-1">ุณุนุฑ ุงููุญุฏุฉ</div>
              <input class="i-unit w-full rounded-lg border border-slate-300 px-2 py-1 number-input" type="number" min="0" step="0.01" value="${fmt(item.priceOnly ? (item.total||item.price) : item.price)}" ${item.priceOnly ? 'disabled' : ''}>
            </div>
            <div>
              <div class="text-xs text-slate-500 mb-1">ุงูุฅุฌูุงูู</div>
              <div class="font-bold">${currency(item.total)}</div>
            </div>
          </div>`;
        const btnDel = row.querySelector('button');
        btnDel.addEventListener('click', ()=>{ cart = cart.filter(x=>x!==item); renderCart(); });
        if (item.priceOnly){
          row.querySelector('.i-price').addEventListener('input', (e)=>{ item.price = Number(e.target.value||0); item.total = item.price; renderCartTotals(); });
        } else {
          row.querySelector('.i-qty').addEventListener('input', (e)=>{
            let q = Math.max(1, Math.floor(Number(e.target.value||1)));
            // stock validation
            const prod = store.state.products.find(p=>p.id===item.productId);
            if (prod && !store.state.settings.allowNegativeStock && q > (Number(prod.stock||0))){
              alert('ุงููููุฉ ุชุชุฌุงูุฒ ุงููุฎุฒูู ุงููุชุงุญ');
              q = Number(prod.stock||0) || 1;
            }
            item.qty = q; item.total = q * item.price; renderCartTotals();
          });
          row.querySelector('.i-unit').addEventListener('input', (e)=>{ item.price = Number(e.target.value||0); item.total = item.qty * item.price; renderCartTotals(); });
        }
        wrap.appendChild(row);
      }
      $('#cart-count').textContent = count;
      // Update subtotal and total after discount
      const discInp = $('#cart-discount-input');
      if (discInp && document.activeElement !== discInp) discInp.value = fmt(cartDiscount);
      $('#cart-subtotal').textContent = currency(subtotal);
      const total = Math.max(0, subtotal - Number(cartDiscount||0));
      $('#cart-total').textContent = currency(total);
    }

    function renderCartTotals(){
      const subtotal = cart.reduce((a,c)=> a + Number(c.total||0), 0);
      const discInp = $('#cart-discount-input');
      if (discInp){
        cartDiscount = Math.max(0, Number(discInp.value||0));
      }
      $('#cart-subtotal').textContent = currency(subtotal);
      const total = Math.max(0, subtotal - Number(cartDiscount||0));
      $('#cart-total').textContent = currency(total);
    }

    function renderRetCart(){
      const wrap = $('#return-items');
      wrap.innerHTML = '';
      let total = 0; let count = 0;
      for (const item of retCart){
        total += Number(item.total||0); count += 1;
        const row = document.createElement('div');
        row.className = 'border border-slate-200 rounded-lg p-2 text-sm';
        row.innerHTML = `
          <div class="flex justify-between items-center gap-2">
            <div>
              <div class="font-bold text-slate-800">${item.name}</div>
              <div class="text-xs text-slate-500">ููุฏ: ${item.code} โข ${item.priceOnly ? 'ุจูุฏ ุจุงูุณุนุฑ' : 'ูููุฉ'}</div>
            </div>
            <button class="text-rose-600 hover:text-rose-700" title="ุญุฐู">โ</button>
          </div>
          <div class="mt-2 grid grid-cols-3 gap-2 items-center">
            <div>
              ${item.priceOnly ? '<div class="text-xs text-slate-500 mb-1">ุงููุจูุบ (ุฏ.ู)</div>' : '<div class="text-xs text-slate-500 mb-1">ุงููููุฉ</div>'}
              ${item.priceOnly ? `<input class="i-price w-full rounded-lg border border-slate-300 px-2 py-1 number-input" type="number" min="0" step="0.01" value="${fmt(item.price)}">` : `<input class="i-qty w-full rounded-lg border border-slate-300 px-2 py-1 number-input" type="number" min="1" step="1" value="${item.qty}">`}
            </div>
            <div>
              <div class="text-xs text-slate-500 mb-1">ุณุนุฑ ุงููุญุฏุฉ</div>
              <input class="i-unit w-full rounded-lg border border-slate-300 px-2 py-1 number-input" type="number" min="0" step="0.01" value="${fmt(item.priceOnly ? (item.total||item.price) : item.price)}" ${item.priceOnly ? 'disabled' : ''}>
            </div>
            <div>
              <div class="text-xs text-slate-500 mb-1">ุงูุฅุฌูุงูู</div>
              <div class="font-bold">${currency(item.total)}</div>
            </div>
          </div>`;
        row.querySelector('button').addEventListener('click', ()=>{ retCart = retCart.filter(x=>x!==item); renderRetCart(); });
        if (item.priceOnly){ row.querySelector('.i-price').addEventListener('input', (e)=>{ item.price = Number(e.target.value||0); item.total = item.price; renderRetTotals(); }); }
        else {
          row.querySelector('.i-qty').addEventListener('input', (e)=>{ let q = Math.max(1, Math.floor(Number(e.target.value||1))); item.qty = q; item.total = q * item.price; renderRetTotals(); });
          row.querySelector('.i-unit').addEventListener('input', (e)=>{ item.price = Number(e.target.value||0); item.total = item.qty * item.price; renderRetTotals(); });
        }
        wrap.appendChild(row);
      }
      $('#return-count').textContent = count;
      $('#return-total').textContent = currency(total);
    }

    function renderRetTotals(){
      const total = retCart.reduce((a,c)=> a + Number(c.total||0), 0);
      $('#return-total').textContent = currency(total);
    }

    // Inventory rendering
    function marginPct(price, cost){ price=Number(price||0); cost=Number(cost||0); if (price<=0) return 0; return ((price - cost) / price) * 100; }
    function renderInventory(){
      const q = ($('#inv-search').value||'').trim().toLowerCase();
      const fcat = $('#inv-cat-filter').value;
      const body = $('#inv-tbody');
      body.innerHTML = '';
      let rows = 0;
      for (const p of store.state.products){
        const okQ = !q || p.name.toLowerCase().includes(q) || String(p.code).includes(q);
        const okCat = fcat==='all' || p.category===fcat;
        if (!okQ || !okCat) continue;
        rows++;
        const mp = marginPct(p.price, p.cost);
        const mpTxt = isFinite(mp) ? mp.toFixed(1) + '%' : '-';
        const expTxt = p.expDate ? new Date(p.expDate).toLocaleDateString('ar-LY') : '-';
        const prodTxt = p.prodDate ? new Date(p.prodDate).toLocaleDateString('ar-LY') : '-';
        const expSoon = p.expDate ? (new Date(p.expDate) - new Date())/(1000*60*60*24) : null;
        const expClass = expSoon!==null ? (expSoon < 0 ? 'text-rose-700 font-bold' : (expSoon<=30 ? 'text-amber-700' : '')) : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${p.code}</td>
          <td class="p-2">${p.name}</td>
          <td class="p-2">${p.category}</td>
          <td class="p-2">${currency(p.price)}</td>
          <td class="p-2">${currency(p.cost||0)}</td>
          <td class="p-2 ${mp>=0?'text-emerald-700':'text-rose-700'}">${p.price>0? mpTxt : '-'}</td>
          <td class="p-2">${p.priceOnly ? '-' : (p.stock ?? 0)}</td>
          <td class="p-2">${prodTxt}</td>
          <td class="p-2 ${expClass}">${expTxt}</td>
          <td class="p-2 text-slate-500 text-xs">${p.priceOnly ? 'ูุจุงุน ุจุงูุณุนุฑ ููุท (ุจุฏูู ูููุฉ)' : ''}</td>
          <td class="p-2">
            <div class="flex flex-wrap gap-2">
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 edit">ุชุนุฏูู</button>
              <button class="px-2 py-1 rounded border border-rose-300 text-rose-600 hover:bg-rose-50 del">ุญุฐู</button>
              ${!p.priceOnly ? '<button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 stock">ุชุนุฏูู ุงููููุฉ</button>' : ''}
            </div>
          </td>`;
        tr.querySelector('.edit').addEventListener('click', ()=> openProductModal(p));
        tr.querySelector('.del').addEventListener('click', ()=> deleteProduct(p.id));
        if (!p.priceOnly) tr.querySelector('.stock').addEventListener('click', ()=> adjustStock(p));
        body.appendChild(tr);
      }
      $('#inv-total-count').textContent = rows;
    }

    function deleteProduct(id){
      if (!confirm('ุชุฃููุฏ ุญุฐู ุงูููุชุฌุ')) return;
      store.state.products = store.state.products.filter(p=>p.id!==id);
      store.save();
      renderInventory();
      renderPOSProducts();
      renderReturnProducts();
      updateDash();
    }

    function adjustStock(p){
      promptModal('ุชุนุฏูู ุงููููุฉ', `ุฃุฏุฎู ุงููููุฉ ุงูุฌุฏูุฏุฉ ููููุชุฌ: ${p.name}`, { fields:[{id:'stock',label:'ุงููููุฉ',type:'number',step:'1',min:'0',value: String(p.stock ?? 0)}] })
        .then(data=>{ if (!data) return; p.stock = Math.max(0, Math.floor(Number(data.stock||0))); store.save(); renderInventory(); renderPOSProducts(); updateDash(); });
    }

    // Product modal
    function openProductModal(p=null){
      const isEdit = !!p;
      const partnerOptions = store.state.settings?.partners || [];
      const fields = [
        ...(isEdit ? [{id:'code',label:'ุงูููุฏ',type:'text',value:p?.code||''}] : []),
        {id:'name',label:'ุงูุงุณู',type:'text',value:p?.name||''},
        {id:'category',label:'ุงูุชุตููู',type:'select',options:['ูุดุฑูุจุงุช','ุนุตุงุฆุฑ','ุดูููุงุชุฉ','ููุงุฏ ุบุฐุงุฆูุฉ','ุจููููุงุช','ููุชุฌุงุช ุตุบูุฑุฉ'],value:p?.category||'ูุดุฑูุจุงุช'},
        {id:'price',label:'ุณุนุฑ ุงูุจูุน (ุฏ.ู)',type:'number',step:'0.01',min:'0',value:fmt(p?.price||0)},
        {id:'cost',label:'ุณุนุฑ ุงูุชูููุฉ (ุฏ.ู)',type:'number',step:'0.01',min:'0',value:fmt(p?.cost||0)},
        {id:'stock',label:'ุงููููุฉ',type:'number',step:'1',min:'0',value: p?.priceOnly ? '' : String(p?.stock ?? 0)},
        {id:'prodDate',label:'ุชุงุฑูุฎ ุงูุฅูุชุงุฌ',type:'date',value: p?.prodDate ? new Date(p.prodDate).toISOString().slice(0,10) : ''},
        {id:'expDate',label:'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ',type:'date',value: p?.expDate ? new Date(p.expDate).toISOString().slice(0,10) : ''},
        {id:'priceOnly',label:'ูุจุงุน ุจุงูุณุนุฑ ููุท (ุจุฏูู ูููุฉ) - ููุจููููุงุช',type:'checkbox',checked: !!p?.priceOnly},
        ...(partnerOptions && partnerOptions.length ? [{
          id:'partner',
          label:'ุงูุดุฑูู',
          type:'select',
          options:['ุจุฏูู ุดุฑูู', ...partnerOptions],
          value: p?.partner || 'ุจุฏูู ุดุฑูู'
        }] : [])
      ];
      promptModal(isEdit ? 'ุชุนุฏูู ููุชุฌ' : 'ุฅุถุงูุฉ ููุชุฌ', 'ูุฑุฌู ุฅุฏุฎุงู ุจูุงูุงุช ุงูููุชุฌ', {fields}).then(data=>{
        if (!data) return;
        let code;
        if (isEdit){
          code = (data.code||'').trim() || (p.code||'');
        } else {
          // ุชูููุฏ ููุฏ ุชููุงุฆู ููููุชุฌ ุงูุฌุฏูุฏ
          code = 'P-' + Math.random().toString(36).slice(2,8);
        }
        const name = (data.name||'').trim();
        const category = data.category;
        const price = Number(data.price||0);
        const cost = Number(data.cost||0);
        const priceOnly = !!data.priceOnly;
        const stock = priceOnly ? null : Math.max(0, Math.floor(Number(data.stock||0)));
        const prodDate = data.prodDate ? new Date(data.prodDate).toISOString() : null;
        const expDate = data.expDate ? new Date(data.expDate).toISOString() : null;
        const partner = data.partner && data.partner !== 'ุจุฏูู ุดุฑูู' ? data.partner : null;
        if (!name){ alert('ุงูุงุณู ุฅุฌุจุงุฑู'); return; }
        if (isEdit){
          if (!code){ alert('ุงูููุฏ ูุงูุงุณู ุฅุฌุจุงุฑูุงู'); return; }
          if (store.state.products.some(x=>x.code===code && x!==p)){ alert('ุงูููุฏ ูุณุชุฎุฏู ูููุชุฌ ุขุฎุฑ'); return; }
          Object.assign(p, {code,name,category,price,cost,priceOnly,stock,prodDate,expDate,partner});
        } else {
          // ุถูุงู ุนุฏู ุชูุฑุงุฑ ุงูููุฏ ุงูุชููุงุฆู ุจุดูู ุจุณูุท
          while (store.state.products.some(x=> String(x.code)===String(code))){
            code = 'P-' + Math.random().toString(36).slice(2,8);
          }
          store.state.products.push({ id:newId('p'), code,name,category,price,cost,priceOnly,stock,prodDate,expDate,partner });
        }
        store.save();
        renderInventory(); renderPOSProducts(); renderReturnProducts(); updateDash();
      });
    }

    // Modal Helper
    function promptModal(title, message, opts={}){
      return new Promise(resolve=>{
        $('#modal-title').textContent = title||'';
        const body = $('#modal-body');
        body.innerHTML = '';
        if (message){ const p = document.createElement('p'); p.className='text-sm text-slate-600'; p.textContent = message; body.appendChild(p); }
        const form = document.createElement('div'); form.className='mt-2 space-y-2';
        const fields = opts.fields||[];
        for (const f of fields){
          const wrap = document.createElement('div');
          const label = document.createElement('label'); label.className='text-sm text-slate-600'; label.textContent = f.label||''; wrap.appendChild(label);
          if (f.type==='select'){
            const sel = document.createElement('select'); sel.className='w-full rounded-lg border border-slate-300 px-3 py-2';
            (f.options||[]).forEach(o=>{ const op = document.createElement('option'); op.value=o; op.textContent=o; if (String(o)===String(f.value)) op.selected = true; sel.appendChild(op); });
            sel.id = f.id; wrap.appendChild(sel);
          } else if (f.type==='checkbox'){
            const chkWrap = document.createElement('div'); chkWrap.className='flex items-center gap-2 mt-1';
            const inp = document.createElement('input'); inp.type='checkbox'; inp.id=f.id; inp.className='rounded border-slate-300'; inp.checked=!!f.checked;
            chkWrap.appendChild(inp);
            const lbl = document.createElement('label'); lbl.textContent = f.label; lbl.htmlFor=f.id; lbl.className='text-sm text-slate-700'; chkWrap.appendChild(lbl);
            wrap.innerHTML=''; wrap.appendChild(chkWrap);
          } else {
            const inp = document.createElement('input'); inp.className='w-full rounded-lg border border-slate-300 px-3 py-2'; inp.id=f.id; inp.type=f.type||'text';
            if (f.step) inp.step=f.step; if (f.min) inp.min=f.min; if (f.max) inp.max=f.max; if (f.placeholder) inp.placeholder=f.placeholder; if (f.value!==undefined) inp.value=f.value;
            wrap.appendChild(inp);
          }
          form.appendChild(wrap);
        }
        body.appendChild(form);
        $('#modal').classList.remove('hidden');
        const cancel = ()=>{ $('#modal').classList.add('hidden'); resolve(null); };
        $('#modal-cancel').onclick = cancel;
        $('#modal-ok').onclick = ()=>{
          const result = {};
          for (const f of fields){
            const el = document.getElementById(f.id);
            if (!el) continue;
            if ((f.type||'')==='checkbox') result[f.id] = el.checked; else result[f.id] = el.value;
          }
          $('#modal').classList.add('hidden');
          resolve(result);
        };
      });
    }

    // Invoice Printing
    function printInvoice(sale){
      const s = sale;
      const cur = store.state.settings.currencySymbol;
      const storeName = store.state.settings.storeName || 'ุงูุณุงุญู ููููุงุฏ ุงูุบุฐุงุฆูุฉ';
      const invNo = s.number ? String(s.number).padStart(6,'0') : null;
      const title = fileSafe(storeName) + '-invoice-' + (invNo || s.id) + '-' + tsFile();
      const win = window.open('', '_blank');
      const itemsRows = s.items.map(i=>{
        const qtyPart = i.priceOnly ? '' : ` ร ${i.qty}`;
        const unitPart = i.priceOnly ? '' : ` @ ${fmt(i.price)} ${cur}`;
        return `<tr><td>${i.name}${qtyPart}${unitPart}</td><td style="text-align:left">${fmt(i.total)} ${cur}</td></tr>`;
      }).join('');
      const pay = payLabel(s.paymentMethod);
      const hasDiscount = Number(s.totals.discount||0) > 0;
      const style = `
        <style>
          @page { size: 80mm auto; margin: 6mm; }
          body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; direction: rtl; color:#0f172a}
          h1{font-size:16px; margin:0 0 4px; text-align:center}
          .meta{font-size:12px; text-align:center; color:#475569; margin-bottom:6px}
          table{width:100%; border-collapse:collapse; font-size:12px}
          td{padding:4px 0; border-bottom:1px dashed #e2e8f0}
          tfoot td{border-top:1px solid #e2e8f0; font-weight:700}
          .center{ text-align:center }
          .muted{ color:#64748b; font-size:11px; text-align:center; margin-top:6px }
        </style>`;
      const totalsRows = hasDiscount
        ? `<tr><td>ุงูุฅุฌูุงูู ูุจู ุงูุฎุตู</td><td style="text-align:left">${fmt(s.totals.subtotal||0)} ${cur}</td></tr>
           <tr><td>ุงูุฎุตู</td><td style="text-align:left">${fmt(s.totals.discount||0)} ${cur}</td></tr>
           <tr><td>ุงูุฅุฌูุงูู</td><td style="text-align:left">${fmt(s.totals.total)} ${cur}</td></tr>
           <tr><td>ุงูุฑุจุญ</td><td style="text-align:left">${fmt((Number(s.totals.total||0)-Number(s.totals.cost||0)))} ${cur}</td></tr>`
        : `<tr><td>ุงูุฅุฌูุงูู</td><td style="text-align:left">${fmt(s.totals.total)} ${cur}</td></tr>
           <tr><td>ุงูุฑุจุญ</td><td style="text-align:left">${fmt((Number(s.totals.total||0)-Number(s.totals.cost||0)))} ${cur}</td></tr>`;
      const extraMeta = s.paymentMethod==='card' && s.cardAuth ? ` โข ุชูููุถ: ${s.cardAuth}` : '';
      win.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">${style}<title>${title}</title></head><body>
        <h1>${storeName}</h1>
        <div class="meta">ูุงุชูุฑุฉ ${s.type==='sale'?'ุจูุน':'ุชุฑุฌูุน'} โข ${fmtDate(s.date)} โข ${invNo?('ุฑูู: '+invNo):('ูุนุฑูู: '+s.id)}</div>
        <div class="meta">${s.customerName?('ุงูุนููู: '+s.customerName+' โข '):''}ุทุฑููุฉ ุงูุฏูุน: ${pay}${extraMeta}</div>
        <table>
          <tbody>${itemsRows}</tbody>
          <tfoot>
            ${totalsRows}
          </tfoot>
        </table>
        <div class="muted">ุดูุฑูุง ูุชุนุงูููู ูุนูุง</div>
        <script>window.onload = ()=> setTimeout(()=> window.print(), 100);<\/script>
      </body></html>`);
      win.document.close();
    }

    function printProformaFromCart(){
      if (cart.length===0){ alert('ุงูุณูุฉ ูุงุฑุบุฉ'); return; }
      const payment = ($('.pay-method:checked')||{}).value || 'cash';
      const date = nowISO();
      const subtotal = cart.reduce((a,c)=> a + Number(c.total||0), 0);
      const discount = Math.max(0, Number($('#cart-discount-input')?.value||cartDiscount||0));
      const total = Math.max(0, subtotal - discount);
      const costTotal = cart.reduce((a,c)=> a + (Number(c.cost||0) * (c.priceOnly? 0 : Number(c.qty||0))), 0);
      const sale = { id:'DRAFT-'+newId('s').slice(2), number:null, type:'sale', items: JSON.parse(JSON.stringify(cart)), paymentMethod: payment, customerId:null, customerName:($('#credit-customer-name').value||'').trim()||null, date, totals: { subtotal, discount, total, cost: costTotal, profit: total - costTotal } };
      printInvoice(sale);
    }

    // Checkout
    function checkout(){
      if (cart.length===0){ alert('ุงูุณูุฉ ูุงุฑุบุฉ'); return; }
      let payment = ($('.pay-method:checked')||{}).value || 'cash';
      let custId = null, custName=null;
      if (payment==='credit'){
        custName = ($('#credit-customer-name').value||'').trim();
        const selId = $('#credit-customer-select').value;
        if (selId) custId = selId; else if (!custName) { alert('ูุฑุฌู ุฅุฏุฎุงู/ุงุฎุชูุงุฑ ุงูุนููู'); return; }
      }
      if (payment==='card'){
        const auth = ($('#card-auth')?.value||'').trim();
        if (!auth){ alert('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูุชูููุถ ููุจุทุงูุฉ'); return; }
      }
      // stock validation for non-priceOnly
      for (const item of cart){
        if (!item.priceOnly){
          const p = store.state.products.find(x=>x.id===item.productId);
          const st = Number(p?.stock||0);
          if (!store.state.settings.allowNegativeStock && item.qty>st){
            alert('ุจุนุถ ุงููููุงุช ุชุชุฌุงูุฒ ุงููุฎุฒูู'); return;
          }
        }
      }
      const date = nowISO();
      const subtotal = cart.reduce((a,c)=> a + Number(c.total||0), 0);
      const discount = Math.max(0, Number($('#cart-discount-input')?.value||cartDiscount||0));
      const total = Math.max(0, subtotal - discount);
      const costTotal = cart.reduce((a,c)=> a + (Number(c.cost||0) * (c.priceOnly? 0 : Number(c.qty||0))), 0);
      const seq = Number(store.state.meta?.invoiceSeq||1);
      const sale = { id:newId('s'), number: seq, type:'sale', items: JSON.parse(JSON.stringify(cart)), paymentMethod: payment, customerId:custId||null, customerName:custName||null, date, totals: { subtotal, discount, total, cost: costTotal, profit: total - costTotal } };
      if (payment==='card'){ sale.cardAuth = ($('#card-auth')?.value||'').trim(); }
      store.state.sales.push(sale);
      // increment seq
      store.state.meta.invoiceSeq = seq + 1;
      // adjust stock
      for (const item of cart){
        if (!item.priceOnly){
          const p = store.state.products.find(x=>x.id===item.productId);
          if (p) p.stock = Number(p.stock||0) - Number(item.qty||0);
        }
      }
      // handle credit
      if (payment==='credit'){
        let customer = null;
        if (custId) customer = store.state.customers.find(c=>c.id===custId);
        if (!customer){ customer = { id:newId('c'), name: custName, phone:'', balance:0, updatedAt:date, transactions:[] }; store.state.customers.push(customer); }
        customer.balance += total; customer.updatedAt = date;
        customer.transactions.push({ id:newId('ct'), type:'sale', amount: total, date, note:'ุจูุน ุนูู ุงูุญุณุงุจ', ref: sale.id });
      }
      store.save();
      // Print the invoice for the completed sale
      printInvoice(sale);
      cart = []; renderCart(); renderInventory(); updateDash();
      alert('ุชูุช ุนูููุฉ ุงูุจูุน ุจูุฌุงุญ');
    }

    // Process return
    function processReturn(){
      if (retCart.length===0){ alert('ุณูุฉ ุงูุชุฑุฌูุน ูุงุฑุบุฉ'); return; }
      let payment = ($('.ret-pay-method:checked')||{}).value || 'cash';
      let custId = null, custName=null;
      if (payment==='credit'){
        custName = ($('#ret-credit-customer-name').value||'').trim();
        const selId = $('#ret-credit-customer-select').value;
        if (selId) custId = selId; else if (!custName) { alert('ูุฑุฌู ุฅุฏุฎุงู/ุงุฎุชูุงุฑ ุงูุนููู'); return; }
      }
      if (payment==='card'){
        const auth = ($('#ret-card-auth')?.value||'').trim();
        if (!auth){ alert('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูุชูููุถ ููุจุทุงูุฉ ูู ุงูุชุฑุฌูุน'); return; }
      }
      const date = nowISO();
      const subtotal = retCart.reduce((a,c)=> a + Number(c.total||0), 0);
      const discount = 0; // ูุง ููุฌุฏ ุฎุตู ูู ุงูุชุฑุฌูุน
      const total = subtotal; // ุฅุฌูุงูู ุงูุชุฑุฌูุน
      const costTotal = retCart.reduce((a,c)=> a + (Number(c.cost||0) * (c.priceOnly? 0 : Number(c.qty||0))), 0);
      const seq = Number(store.state.meta?.invoiceSeq||1);
      const sale = { id:newId('s'), number: seq, type:'return', items: JSON.parse(JSON.stringify(retCart)), paymentMethod: payment, customerId:custId||null, customerName:custName||null, date, totals: { subtotal, discount, total: -total, cost: -costTotal, profit: -(total - costTotal) } };
      if (payment==='card'){ sale.cardAuth = ($('#ret-card-auth')?.value||'').trim(); }
      store.state.sales.push(sale);
      store.state.meta.invoiceSeq = seq + 1;
      // adjust stock back
      for (const item of retCart){
        if (!item.priceOnly){ const p = store.state.products.find(x=>x.id===item.productId); if (p) p.stock = Number(p.stock||0) + Number(item.qty||0); }
      }
      // handle credit: reduce customer's balance
      if (payment==='credit'){
        let customer = null;
        if (custId) customer = store.state.customers.find(c=>c.id===custId);
        if (!customer){ customer = { id:newId('c'), name: custName, phone:'', balance:0, updatedAt:date, transactions:[] }; store.state.customers.push(customer); }
        customer.balance -= total; customer.updatedAt = date;
        customer.transactions.push({ id:newId('ct'), type:'return', amount: -total, date, note:'ุชุฑุฌูุน ุนูู ุงูุญุณุงุจ', ref: sale.id });
      }
      store.save();
      // Print return invoice
      printInvoice(sale);
      retCart = []; renderRetCart(); renderInventory(); updateDash();
      alert('ุชูุช ุนูููุฉ ุงูุชุฑุฌูุน ุจูุฌุงุญ');
    }

    // Customers
    function renderCustomers(){
      const q = ($('#cust-search').value||'').trim().toLowerCase();
      const body = $('#cust-tbody'); body.innerHTML = '';
      for (const c of store.state.customers){
        if (q && !(c.name.toLowerCase().includes(q) || (c.phone||'').includes(q))) continue;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 font-bold">${c.name}</td>
          <td class="p-2">${c.phone||'-'}</td>
          <td class="p-2 ${c.balance>0 ? 'text-amber-700' : 'text-emerald-700'}">${currency(c.balance)}</td>
          <td class="p-2 text-slate-500 text-xs">${fmtDate(c.updatedAt)}</td>
          <td class="p-2">
            <div class="flex flex-wrap gap-2">
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 pay">ุฏูุน ุงูุฏูู</button>
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 view">ุชูุงุตูู</button>
              <button class="px-2 py-1 rounded border border-rose-300 text-rose-600 hover:bg-rose-50 del">ุญุฐู</button>
            </div>
          </td>`;
        tr.querySelector('.pay').addEventListener('click', ()=> payDebt(c));
        tr.querySelector('.view').addEventListener('click', ()=> viewCustomer(c));
        tr.querySelector('.del').addEventListener('click', ()=> deleteCustomer(c.id));
        body.appendChild(tr);
      }
    }

    function deleteCustomer(id){
      if (!confirm('ุญุฐู ุงูุนููู ุณูุญุฐู ูุนุงููุงุชู ุงูุฏุงุฎููุฉ ูู ุงูุณุฌู (ูู ูุญุฐู ุงููุจูุนุงุช). ุชุฃููุฏุ')) return;
      store.state.customers = store.state.customers.filter(c=>c.id!==id);
      store.save(); renderCustomers();
    }

    function payDebt(c){
      promptModal('ุฏูุน ุงูุฏูู', `ุฅุฏุฎุงู ุฏูุนุฉ ููุนููู: ${c.name}`, {fields:[{id:'amount',label:'ุงููุจูุบ (ุฏ.ู)',type:'number',min:'0',step:'0.01',value:fmt(Math.max(0,c.balance))},{id:'note',label:'ููุงุญุธุฉ',type:'text',value:'ุฏูุน ุฏูู'}]}).then(data=>{
        if (!data) return; const amount = Number(data.amount||0); if (!(amount>0)) return;
        const date = nowISO();
        c.balance = Math.max(0, Number(c.balance||0) - amount);
        c.transactions.push({ id:newId('ct'), type:'payment', amount: -amount, date, note: data.note||'ุฏูุน ุฏูู' });
        c.updatedAt = date; store.save(); renderCustomers();
      });
    }

    function viewCustomer(c){
      const body = document.createElement('div');
      body.innerHTML = `<div class="text-sm text-slate-700">ุงูุฑุตูุฏ ุงูุญุงูู: <strong>${currency(c.balance)}</strong></div>`;
      const list = document.createElement('div'); list.className='mt-2 max-h-[260px] overflow-auto';
      for (const t of (c.transactions||[]).slice().reverse()){
        const div = document.createElement('div');
        const typeTxt = t.type==='sale' ? 'ุจูุน ุนูู ุงูุญุณุงุจ' : (t.type==='return' ? 'ุชุฑุฌูุน' : 'ุฏูุน');
        div.className='text-sm border-b border-slate-100 py-1';
        div.textContent = `${typeTxt} โข ${fmtDate(t.date)} โข ${currency(t.amount)}`;
        list.appendChild(div);
      }
      body.appendChild(list);
      // open modal
      $('#modal-title').textContent = 'ุชูุงุตูู ุงูุนููู - ' + c.name;
      $('#modal-body').innerHTML = '';
      $('#modal-body').appendChild(body);
      $('#modal').classList.remove('hidden');
      $('#modal-ok').textContent = 'ุฅุบูุงู';
      $('#modal-cancel').classList.add('hidden');
      const close = ()=>{ $('#modal').classList.add('hidden'); $('#modal-ok').textContent='ููุงูู'; $('#modal-cancel').classList.remove('hidden'); };
      $('#modal-ok').onclick = close;
      $('#modal-cancel').onclick = close;
    }

    // Suppliers
    function renderSuppliers(){
      const q = ($('#sup-search').value||'').trim().toLowerCase();
      const body = $('#sup-tbody'); if (!body) return; body.innerHTML='';
      for (const s of store.state.suppliers){
        if (q && ![s.name||'', s.phone||'', s.company||''].some(v=> String(v).toLowerCase().includes(q))) continue;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 font-bold">${s.name}</td>
          <td class="p-2">${s.phone||'-'}</td>
          <td class="p-2">${s.company||'-'}</td>
          <td class="p-2 ${Number(s.balance||0)>0?'text-amber-700':'text-emerald-700'}">${currency(s.balance||0)}</td>
          <td class="p-2 text-slate-500 text-xs">${s.updatedAt?fmtDate(s.updatedAt):'-'}</td>
          <td class="p-2">
            <div class="flex flex-wrap gap-2">
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 addp">ุนูููุฉ</button>
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 paysup">ุฏูุน</button>
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 view">ุชูุงุตูู</button>
              <button class="px-2 py-1 rounded border border-rose-300 text-rose-600 hover:bg-rose-50 del">ุญุฐู</button>
            </div>
          </td>`;
        tr.querySelector('.addp').addEventListener('click', ()=> supplierTransaction(s));
        const btnPay = tr.querySelector('.paysup'); if (btnPay) btnPay.addEventListener('click', ()=> paySupplier(s));
        tr.querySelector('.view').addEventListener('click', ()=> viewSupplier(s));
        tr.querySelector('.del').addEventListener('click', ()=> deleteSupplier(s.id));
        body.appendChild(tr);
      }
    }

    function addSupplier(){
      promptModal('ููุฑุฏ ุฌุฏูุฏ', 'ุฃุฏุฎู ุจูุงูุงุช ุงูููุฑุฏ', {fields:[
        {id:'name',label:'ุงูุงุณู',type:'text'},
        {id:'phone',label:'ุงููุงุชู',type:'text'},
        {id:'company',label:'ุงูุดุฑูุฉ',type:'text'},
        {id:'note',label:'ููุงุญุธุงุช',type:'text'}
      ]}).then(data=>{
        if (!data) return; const name=(data.name||'').trim(); if (!name) return alert('ุงูุงุณู ูุทููุจ');
        const s={ id:newId('sup'), name, phone:(data.phone||'').trim(), company:(data.company||'').trim(), note:(data.note||'').trim(), balance:0, updatedAt: nowISO(), transactions:[] };
        store.state.suppliers.push(s); store.save(); renderSuppliers();
      });
    }

    function supplierTransaction(sup){
      promptModal('ุนูููุฉ ููููุฑุฏ', `ุฅุถุงูุฉ ุนูููุฉ ูุงููุฉ ูุน ุงูููุฑุฏ: ${sup.name}`, {fields:[
        {id:'type',label:'ุงูููุน',type:'select',options:['purchase','payment'],value:'purchase'},
        {id:'amount',label:'ุงููุจูุบ (ุฏ.ู)',type:'number',min:'0',step:'0.01',value:'0.00'},
        {id:'note',label:'ููุงุญุธุฉ',type:'text',value:''}
      ]}).then(data=>{
        if (!data) return; const amount = Number(data.amount||0); if (!(amount>0)) return;
        const date = nowISO();
        const type = data.type;
        const note = data.note||'';
        sup.updatedAt = date;
        if (type==='purchase'){ sup.balance = Number(sup.balance||0) + amount; }
        else { sup.balance = Math.max(0, Number(sup.balance||0) - amount); }
        sup.transactions = sup.transactions||[];
        sup.transactions.push({ id:newId('st'), type, amount: type==='purchase'? amount : -amount, date, note });
        store.save(); renderSuppliers();
      });
    }

    function paySupplier(sup){
      // Quick payment dialog dedicated for suppliers
      promptModal('ุฏูุน ููููุฑุฏ', `ุชุณุฌูู ุฏูุน ููููุฑุฏ: ${sup.name}`, {fields:[
        {id:'amount',label:'ุงููุจูุบ (ุฏ.ู)',type:'number',min:'0',step:'0.01',value: fmt(Math.min(Number(sup.balance||0), Number(sup.balance||0))||0)},
        {id:'note',label:'ููุงุญุธุฉ',type:'text',value:'ุฏูุน ููููุฑุฏ'}
      ]}).then(data=>{
        if (!data) return; const amount = Number(data.amount||0); if (!(amount>0)) return;
        const date = nowISO();
        sup.balance = Math.max(0, Number(sup.balance||0) - amount);
        sup.updatedAt = date;
        sup.transactions = sup.transactions||[];
        sup.transactions.push({ id:newId('st'), type:'payment', amount: -amount, date, note: data.note||'ุฏูุน ููููุฑุฏ' });
        store.save(); renderSuppliers(); runReport();
      });
    }

    function viewSupplier(s){
      const body = document.createElement('div');
      body.innerHTML = `<div class="text-sm text-slate-700">ุงูุฑุตูุฏ ุงูุญุงูู ููููุฑุฏ: <strong>${currency(s.balance||0)}</strong></div>`;
      const list = document.createElement('div'); list.className='mt-2 max-h-[260px] overflow-auto';
      for (const t of (s.transactions||[]).slice().reverse()){
        const div = document.createElement('div');
        const typeTxt = t.type==='purchase' ? 'ุนูููุฉ ุดุฑุงุก (ูุณุชุญู)' : 'ุฏูุน ููููุฑุฏ';
        div.className='text-sm border-b border-slate-100 py-1';
        div.textContent = `${typeTxt} โข ${fmtDate(t.date)} โข ${currency(t.amount)}`;
        list.appendChild(div);
      }
      body.appendChild(list);
      $('#modal-title').textContent = 'ุชูุงุตูู ุงูููุฑุฏ - ' + s.name;
      $('#modal-body').innerHTML = '';
      $('#modal-body').appendChild(body);
      $('#modal').classList.remove('hidden');
      $('#modal-ok').textContent = 'ุฅุบูุงู';
      $('#modal-cancel').classList.add('hidden');
      const close = ()=>{ $('#modal').classList.add('hidden'); $('#modal-ok').textContent='ููุงูู'; $('#modal-cancel').classList.remove('hidden'); };
      $('#modal-ok').onclick = close; $('#modal-cancel').onclick = close;
    }

    function deleteSupplier(id){
      if (!confirm('ุชุฃููุฏ ุญุฐู ุงูููุฑุฏุ')) return;
      store.state.suppliers = store.state.suppliers.filter(s=>s.id!==id);
      store.save(); renderSuppliers();
    }

    // Expenses
    function renderExpenses(){
      const body = $('#exp-tbody'); body.innerHTML='';
      let total = 0;
      for (const e of store.state.expenses.slice().reverse()){
        total += Number(e.amount||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${fmtDate(e.date)}</td>
          <td class="p-2">${currency(e.amount)}</td>
          <td class="p-2">${e.note||''}</td>
          <td class="p-2"><button class="px-2 py-1 rounded border border-rose-300 text-rose-600 hover:bg-rose-50 del">ุญุฐู</button></td>`;
        tr.querySelector('.del').addEventListener('click', ()=>{ if(!confirm('ุชุฃููุฏ ุญุฐู ุงููุตุฑููุ')) return; store.state.expenses = store.state.expenses.filter(x=>x.id!==e.id); store.save(); renderExpenses(); updateDash(); });
        body.appendChild(tr);
      }
      $('#exp-total').textContent = currency(total);
    }

    // Reports
    let lastReport = null;
    function runReport(){
      const type = $('#rep-type').value;
      const dateStr = $('#rep-date').value;
      const monthStr = $('#rep-month').value;
      const yearVal = Number($('#rep-year')?.value||'');
      let inRange, rangeLabel;
      if (type==='daily'){
        const d = new Date(dateStr||new Date());
        inRange = (iso)=>{ const dt = new Date(iso); return dt.getFullYear()===d.getFullYear() && dt.getMonth()===d.getMonth() && dt.getDate()===d.getDate(); };
        rangeLabel = d.toLocaleDateString('ar-LY', { year:'numeric', month:'2-digit', day:'2-digit' });
      } else if (type==='monthly') {
        const d = new Date(monthStr ? monthStr+'-01' : new Date());
        inRange = (iso)=>{ const dt = new Date(iso); return dt.getFullYear()===d.getFullYear() && dt.getMonth()===d.getMonth(); };
        rangeLabel = d.toLocaleDateString('ar-LY', { year:'numeric', month:'2-digit' }).replace('/','-');
      } else { // yearly
        const y = yearVal || new Date().getFullYear();
        inRange = (iso)=>{ const dt = new Date(iso); return dt.getFullYear()===y; };
        rangeLabel = String(y);
      }
      const sales = store.state.sales.filter(s=> inRange(s.date));
      const expenses = store.state.expenses.filter(e=> inRange(e.date));
      // Totals
      const totalSales = sales.reduce((a,s)=> a + Number(s.totals.total||0), 0);
      const totalCost = sales.reduce((a,s)=> a + Number(s.totals.cost||0), 0);
      const expTotal = expenses.reduce((a,e)=> a + Number(e.amount||0), 0);
      const profit = (totalSales - totalCost) - expTotal;
      $('#rep-sales').textContent = currency(totalSales);
      $('#rep-cost').textContent = currency(totalCost);
      $('#rep-exp').textContent = currency(expTotal);
      $('#rep-profit').textContent = currency(profit);
      // Gross products value (before discount), net of returns
      const gross = sales.reduce((a,s)=>{
        const sub = Number((s.totals && s.totals.subtotal) ? s.totals.subtotal : s.totals.total||0);
        return a + (s.type==='sale' ? sub : -sub);
      }, 0);
      const repGrossEl = document.getElementById('rep-gross'); if (repGrossEl) repGrossEl.textContent = currency(gross);
      // Current debts
      const custDebt = (store.state.customers||[]).reduce((a,c)=> a + Number(c.balance||0), 0);
      const supDebt = (store.state.suppliers||[]).reduce((a,s)=> a + Number(s.balance||0), 0);
      const repCustDebtEl = document.getElementById('rep-cust-debt'); if (repCustDebtEl) repCustDebtEl.textContent = currency(custDebt);
      const repSupDebtEl = document.getElementById('rep-sup-debt'); if (repSupDebtEl) repSupDebtEl.textContent = currency(supDebt);
      // Build combined transactions list (sales/returns + expenses)
      const combined = [];
      for (const s of sales){
        const rowProfit = Number(s.totals.total||0) - Number(s.totals.cost||0);
        combined.push({ kind:'sale', type: s.type==='sale'?'ุจูุน':'ุชุฑุฌูุน', datetime: s.date, pay: payLabel(s.paymentMethod), total: s.totals.total, items: s.items.map(i=> i.priceOnly ? `${i.name} โข ${fmt(i.total)} ${store.state.settings.currencySymbol}` : `${i.name} ร ${i.qty} @ ${fmt(i.price)} ${store.state.settings.currencySymbol} = ${fmt(i.total)} ${store.state.settings.currencySymbol}`).join('ุ '), profit: rowProfit, number: s.number? String(s.number).padStart(6,'0'):'' , ref: s });
      }
      for (const e of expenses){
        combined.push({ kind:'expense', type:'ูุตุฑูู', datetime: e.date, pay:'-', total: -Number(e.amount||0), items: e.note||'', profit: -Number(e.amount||0), number:'', ref: e });
      }
      combined.sort((a,b)=> new Date(b.datetime) - new Date(a.datetime));
      // transactions table
      const tbody = $('#rep-tbody'); tbody.innerHTML='';
      for (const c of combined){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${c.type}</td>
          <td class="p-2">${fmtDate(c.datetime)}</td>
          <td class="p-2">${c.pay}</td>
          <td class="p-2">${currency(c.total)}</td>
          <td class="p-2 text-slate-600">${c.items}</td>
          <td class="p-2 ${c.profit>=0?'text-emerald-700':'text-rose-700'}">${currency(c.profit)}</td>
          <td class="p-2">${c.number}</td>
          <td class="p-2">${c.kind==='sale' ? '<div class="flex gap-2"><button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 rep-print">ุทุจุงุนุฉ</button><button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 rep-pdf">PDF</button></div>' : ''}</td>`;
        if (c.kind==='sale'){
          tr.querySelector('.rep-print').addEventListener('click', ()=> printInvoice(c.ref));
          tr.querySelector('.rep-pdf').addEventListener('click', ()=> printInvoice(c.ref));
        }
        tbody.appendChild(tr);
      }
      // payment breakdown
      const pays = { cash:0, card:0, credit:0 };
      for (const s of sales){ pays[s.paymentMethod] += Number(s.totals.total||0); }
      const paysWrap = $('#rep-pays'); paysWrap.innerHTML='';
      for (const k of ['cash','card','credit']){
        const li = document.createElement('li');
        const label = k==='cash' ? 'ููุฏูุง' : k==='card' ? 'ุจุทุงูุฉ' : 'ุนูู ุงูุญุณุงุจ';
        li.textContent = `${label}: ${currency(pays[k])}`;
        paysWrap.appendChild(li);
      }
      // products breakdown
      const prods = new Map();
      for (const s of sales){
        for (const i of s.items){
          const key = i.name + (i.priceOnly? ' (ุณุนุฑ)' : '');
          if (!prods.has(key)) prods.set(key, { qty:0, total:0 });
          prods.get(key).qty += i.priceOnly ? 0 : (s.type==='sale'? i.qty : -i.qty);
          prods.get(key).total += s.type==='sale' ? Number(i.total||0) : -Number(i.total||0);
        }
      }
      const prodWrap = $('#rep-products'); prodWrap.innerHTML='';
      for (const [name,agg] of prods){
        const li = document.createElement('li');
        const qtyTxt = agg.qty ? ` โข ูููุฉ: ${agg.qty}` : '';
        li.textContent = `${name}: ${currency(agg.total)}${qtyTxt}`;
        prodWrap.appendChild(li);
      }
      // partners breakdown (by ุตุงุญุจ ุงูุจุถุงุนุฉ)
      const partners = new Map();
      for (const s of sales){
        const sign = s.type === 'sale' ? 1 : -1;
        for (const i of s.items){
          const prod = store.state.products.find(p=>p.id===i.productId);
          const partnerName = prod && prod.partner ? prod.partner : null;
          if (!partnerName) continue;
          if (!partners.has(partnerName)) partners.set(partnerName, { total:0, cost:0, categories:new Map() });
          const agg = partners.get(partnerName);
          const itemTotal = Number(i.total||0) * sign;
          const unitCost = Number(i.cost || prod?.cost || 0);
          const qty = i.priceOnly ? 0 : Number(i.qty||0);
          const itemCost = unitCost * qty * sign;
          agg.total += itemTotal;
          agg.cost += itemCost;
          const cat = prod?.category || 'ุบูุฑ ูุตูู';
          if (!agg.categories.has(cat)) agg.categories.set(cat, 0);
          agg.categories.set(cat, agg.categories.get(cat) + itemTotal);
        }
      }
      const partnersWrap = document.getElementById('rep-partners');
      if (partnersWrap){
        partnersWrap.innerHTML = partners.size ? '' : '<li class="text-slate-400">ูุง ููุฌุฏ ุจูุงูุงุช ููุดุฑูุงุก ูู ูุฐู ุงููุชุฑุฉ</li>';
        for (const [name,agg] of partners){
          const profitPartner = agg.total - agg.cost;
          const cats = Array.from(agg.categories.entries()).map(([cat,val])=>`${cat}: ${currency(val)}`).join('ุ ');
          const li = document.createElement('li');
          li.textContent = `${name} โข ูููุฉ ุงููุจูุนุงุช: ${currency(agg.total)} โข ุงูุฑุจุญ: ${currency(profitPartner)}${cats ? ' โข ' + cats : ''}`;
          partnersWrap.appendChild(li);
        }
      }
      // supplier transactions (in range) + per-supplier summary
      const supList = [];
      const supSummary = [];
      const suppliersArr = (store.state.suppliers||[]);
      for (const s of suppliersArr){
        let periodPurchases = 0; // sum of purchases in range
        let periodPaymentsAbs = 0; // sum of payments (absolute) in range
        for (const t of (s.transactions||[])){
          if (!inRange(t.date)) continue;
          if (t.type==='purchase'){ periodPurchases += Number(t.amount||0); supList.push({ supplier:s.name, type:'ุดุฑุงุก ูู ุงูููุฑุฏ', datetime:t.date, amount:t.amount, note:t.note||'' }); }
          else if (t.type==='payment'){ periodPaymentsAbs += Math.abs(Number(t.amount||0)); supList.push({ supplier:s.name, type:'ุฏูุน ููููุฑุฏ', datetime:t.date, amount:t.amount, note:t.note||'' }); }
        }
        // current remaining balance is supplier.balance
        const remaining = Number(s.balance||0);
        supSummary.push({ supplier:s.name, purchases: periodPurchases, payments: periodPaymentsAbs, balance: remaining });
      }
      supList.sort((a,b)=> new Date(b.datetime)-new Date(a.datetime));
      // Render summary
      const supSumWrap = document.getElementById('rep-suppliers-summary');
      if (supSumWrap){
        supSumWrap.innerHTML = supSummary.length? '' : '<li class="text-slate-400">ูุง ููุฌุฏ ููุฑุฏูู</li>';
        for (const ss of supSummary){
          const li = document.createElement('li');
          li.textContent = `${ss.supplier} โข ูุดุชุฑูุงุช ุงููุชุฑุฉ: ${currency(ss.purchases)} โข ุงููุฏููุน ุงููุชุฑุฉ: ${currency(ss.payments)} โข ุงููุชุจูู: ${currency(ss.balance)}`;
          supSumWrap.appendChild(li);
        }
      }
      // Render transactions
      const supWrap = document.getElementById('rep-suppliers'); if (supWrap){ supWrap.innerHTML = supList.length? '' : '<li class="text-slate-400">ูุง ูุนุงููุงุช ููููุฑุฏูู</li>'; }
      if (supWrap){
        for (const t of supList){ const li=document.createElement('li'); li.textContent = `${t.supplier} โข ${t.type} โข ${fmtDate(t.datetime)} โข ${currency(t.amount)}${t.note? ' โข '+t.note:''}`; supWrap.appendChild(li); }
      }
      // store last report
      lastReport = {
        type,
        dateStr, monthStr,
        year: type==='yearly' ? (rangeLabel) : null,
        rangeLabel,
        generatedAt: nowISO(),
        sales: sales.slice(),
        expenses: expenses.slice(),
        supplierTransactions: supList.slice(),
        totals: { totalSales, totalCost, expTotal, profit, gross, custDebt, supDebt },
        pays: Object.assign({}, pays),
        products: Array.from(prods, ([name,agg])=>({ name, qty: agg.qty, total: agg.total })),
        partners: Array.from(partners, ([name,agg])=>({
          name,
          total: agg.total,
          cost: agg.cost,
          profit: agg.total - agg.cost,
          categories: Array.from(agg.categories.entries()).map(([cat,val])=>({ cat, total: val }))
        })),
        suppliers: supSummary.slice(),
        supplierTransactions: supList.slice()
      };
    }

    function exportReportCSV(){
      if (!lastReport) runReport();
      const r = lastReport;
      const lines = [];
      const storeName = store.state.settings.storeName || 'ุงูุณุงุญู ููููุงุฏ ุงูุบุฐุงุฆูุฉ';
      lines.push('\ufeff"ุชูุฑูุฑ ุงูููุธููุฉ","' + storeName.replaceAll('"','""') + '","ุงูููุน","' + (r.type==='daily'?'ูููู':(r.type==='monthly'?'ุดูุฑู':'ุณููู')) + '","ุงููุชุฑุฉ","' + r.rangeLabel + '"');
      lines.push('"ุชู ุงูุฅูุดุงุก","' + fmtDate(r.generatedAt) + '"');
      lines.push('');
      lines.push('ุงูููุน,ุงูุชุงุฑูุฎ ูุงูููุช,ุทุฑููุฉ ุงูุฏูุน,ุงูุฅุฌูุงูู ูุจู ุงูุฎุตู,ุงูุฎุตู,ุงูุฅุฌูุงูู ุจุนุฏ ุงูุฎุตู,ุงูุฑุจุญ,ุงูุฃุตูุงู (ุจุงูุฃุณุนุงุฑ)');
      for (const s of r.sales){
        const typeTxt = s.type==='sale' ? 'ุจูุน' : 'ุชุฑุฌูุน';
        const payTxt = s.paymentMethod==='cash' ? 'ููุฏูุง' : s.paymentMethod==='card' ? 'ุจุทุงูุฉ' : 'ุนูู ุงูุญุณุงุจ';
        const itemsTxt = s.items.map(i=> i.priceOnly ? `${i.name} = ${fmt(i.total)}` : `${i.name} ร ${i.qty} @ ${fmt(i.price)} = ${fmt(i.total)}`).join(' + ');
        const row = [typeTxt, fmtDate(s.date), payTxt, fmt(s.totals.subtotal||s.totals.total), fmt(s.totals.discount||0), fmt(s.totals.total), fmt((Number(s.totals.total||0)-Number(s.totals.cost||0))), itemsTxt].map(v=> '"' + String(v).replaceAll('"','""') + '"').join(',');
        lines.push(row);
      }
      // Append expenses rows
      lines.push('');
      lines.push('ุงูููุน,ุงูุชุงุฑูุฎ ูุงูููุช,ุทุฑููุฉ ุงูุฏูุน,ุงููููุฉ,ููุงุญุธุฉ');
      for (const e of r.expenses||[]){
        const row = ['ูุตุฑูู', fmtDate(e.date), '-', fmt(e.amount), e.note||''].map(v=> '"' + String(v).replaceAll('"','""') + '"').join(',');
        lines.push(row);
      }
      // Append supplier transactions
      lines.push('');
      lines.push('ููุฎุต ุงูููุฑุฏูู: ุงูููุฑุฏ,ูุดุชุฑูุงุช ุงููุชุฑุฉ,ุงููุฏููุน ูู ุงููุชุฑุฉ,ุงููุชุจูู ุงูุญุงูู');
      for (const s of r.suppliers||[]){
        const row = [s.supplier, fmt(s.purchases||0), fmt(s.payments||0), fmt(s.balance||0)].map(v=> '"' + String(v).replaceAll('"','""') + '"').join(',');
        lines.push(row);
      }
      lines.push('');
      lines.push('ุงูููุฑุฏ,ุงูููุน,ุงูุชุงุฑูุฎ ูุงูููุช,ุงููููุฉ,ููุงุญุธุฉ');
      for (const t of r.supplierTransactions||[]){
        const row = [t.supplier, t.type, fmtDate(t.datetime), fmt(t.amount), t.note||''].map(v=> '"' + String(v).replaceAll('"','""') + '"').join(',');
        lines.push(row);
      }
      lines.push('');
      lines.push('"ุงูุฅุฌูุงููุงุช","ุงููุจูุนุงุช","' + fmt(r.totals.totalSales) + '","ุงูุชูููุฉ","' + fmt(r.totals.totalCost) + '","ุงููุตุฑููุงุช","' + fmt(r.totals.expTotal) + '","ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ","' + fmt(r.totals.profit) + '","ูููุฉ ุงูููุชุฌุงุช (ูุจู ุงูุฎุตู)","' + fmt(r.totals.gross||0) + '","ุฏูู ุงูุนููุงุก","' + fmt(r.totals.custDebt||0) + '","ุฏูู ุงูููุฑุฏูู","' + fmt(r.totals.supDebt||0) + '"');
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = fileSafe(storeName) + '-' + r.rangeLabel + '-report.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function printReport(){
      if (!lastReport) runReport();
      const r = lastReport;
      const win = window.open('', '_blank');
      const cur = store.state.settings.currencySymbol;
      const style = `
        <style>
          body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; direction: rtl; padding:16px; color:#0f172a}
          h1{font-size:20px; margin:0 0 6px}
          .grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px}
          .card{border:1px solid #e2e8f0; background:#f8fafc; border-radius:10px; padding:10px}
          table{width:100%; border-collapse:collapse; margin-top:10px}
          th,td{border:1px solid #e2e8f0; padding:6px; text-align:right; font-size:12px}
          th{background:#f1f5f9; color:#334155}
          ul{margin:6px 0; padding:0 16px}
          .muted{color:#64748b; font-size:12px}
        </style>`;
      const paysList = ['cash','card','credit'].map(k=>{
        const label = k==='cash'?'ููุฏูุง':k==='card'?'ุจุทุงูุฉ':'ุนูู ุงูุญุณุงุจ';
        return `<li>${label}: ${fmt(r.pays[k]||0)} ${cur}</li>`;
      }).join('');
      const prodList = r.products.map(p=> `<li>${p.name}: ${fmt(p.total)} ${cur}${p.qty?` โข ูููุฉ: ${p.qty}`:''}</li>`).join('');
      // Build combined rows (sales/returns + expenses)
      const merged = [];
      for (const s of r.sales){
        const typeTxt = s.type==='sale' ? 'ุจูุน' : 'ุชุฑุฌูุน';
        const payTxt = s.paymentMethod==='cash' ? 'ููุฏูุง' : s.paymentMethod==='card' ? 'ุจุทุงูุฉ' : 'ุนูู ุงูุญุณุงุจ';
        const itemsTxt = s.items.map(i=> i.priceOnly ? `${i.name} โข ${fmt(i.total)} ${cur}` : `${i.name} ร ${i.qty} @ ${fmt(i.price)} ${cur} = ${fmt(i.total)} ${cur}`).join('ุ ');
        merged.push({ dt:s.date, html:`<tr><td>${typeTxt}</td><td>${fmtDate(s.date)}</td><td>${payTxt}</td><td>${fmt(s.totals.total)} ${cur}</td><td>${itemsTxt}</td></tr>` });
      }
      for (const e of r.expenses||[]){
        merged.push({ dt:e.date, html:`<tr><td>ูุตุฑูู</td><td>${fmtDate(e.date)}</td><td>-</td><td>${fmt(e.amount)} ${cur}</td><td>${(e.note||'')}</td></tr>` });
      }
      merged.sort((a,b)=> new Date(b.dt) - new Date(a.dt));
      const rows = merged.map(x=> x.html).join('');
      win.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">${style}<title>ุชูุฑูุฑ ${r.rangeLabel}</title></head><body>
        <h1>ุชูุฑูุฑ ${r.type==='daily'?'ูููู':(r.type==='monthly'?'ุดูุฑู':'ุณููู')} โข ${r.rangeLabel}</h1>
        <div class="muted">ุชู ุงูุฅูุดุงุก: ${fmtDate(r.generatedAt)} โข ุงูุฅุตุฏุงุฑ v${APP_VERSION}</div>
        <div class="grid" style="margin-top:10px">
          <div class="card"><div class="muted">ุฅุฌูุงูู ุงููุจูุนุงุช</div><div style="font-weight:800; font-size:18px">${fmt(r.totals.totalSales)} ${cur}</div></div>
          <div class="card"><div class="muted">ุชูููุฉ ุงูุจุถุงุนุฉ</div><div style="font-weight:800; font-size:18px">${fmt(r.totals.totalCost)} ${cur}</div></div>
          <div class="card"><div class="muted">ุฅุฌูุงูู ุงููุตุฑููุงุช</div><div style="font-weight:800; font-size:18px">${fmt(r.totals.expTotal)} ${cur}</div></div>
          <div class="card"><div class="muted">ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ</div><div style="font-weight:800; font-size:18px">${fmt(r.totals.profit)} ${cur}</div></div>
        </div>
        <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-top:12px">
          <div>
            <h2 style="font-size:16px; margin:0 0 4px">ุชูุตูู ุทุฑู ุงูุฏูุน</h2>
            <ul>${paysList}</ul>
          </div>
          <div>
            <h2 style="font-size:16px; margin:0 0 4px">ุชูุตูู ุงูููุชุฌุงุช</h2>
            <ul>${prodList}</ul>
          </div>
        </div>
        <h2 style="font-size:16px; margin:12px 0 4px">ุงููุนุงููุงุช</h2>
        <table>
          <thead><tr><th>ุงูููุน</th><th>ุงูุชุงุฑูุฎ ูุงูููุช</th><th>ุทุฑููุฉ ุงูุฏูุน</th><th>ุงูุฅุฌูุงูู</th><th>ุงูุฃุตูุงู</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <script>window.onload = ()=> setTimeout(()=> window.print(), 100);<\/script>
      </body></html>`);
      win.document.close();
    }

    function printReportSection(section){
      if (!lastReport) runReport();
      const r = lastReport;
      const cur = store.state.settings.currencySymbol;
      const win = window.open('', '_blank');
      let title = '';
      let content = '';
      const style = `<style>body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; direction: rtl; padding:16px; color:#0f172a}h1{font-size:18px;margin:0 0 6px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #e2e8f0;padding:6px;text-align:right;font-size:12px}th{background:#f1f5f9}</style>`;
      if (section==='transactions'){
        title = `ุงููุนุงููุงุช โข ${r.rangeLabel}`;
        const rows = r.sales.slice().reverse().map(s=>{
          const typeTxt = s.type==='sale' ? 'ุจูุน' : 'ุชุฑุฌูุน';
          const payTxt = payLabel(s.paymentMethod);
          const itemsTxt = s.items.map(i=> i.priceOnly ? `${i.name} โข ${fmt(i.total)} ${cur}` : `${i.name} ร ${i.qty} @ ${fmt(i.price)} ${cur} = ${fmt(i.total)} ${cur}`).join('ุ ');
          return `<tr><td>${typeTxt}</td><td>${fmtDate(s.date)}</td><td>${payTxt}</td><td>${fmt(s.totals.total)} ${cur}</td><td>${itemsTxt}</td></tr>`;
        }).join('');
        content = `<table><thead><tr><th>ุงูููุน</th><th>ุงูุชุงุฑูุฎ ูุงูููุช</th><th>ุทุฑููุฉ ุงูุฏูุน</th><th>ุงูุฅุฌูุงูู</th><th>ุงูุฃุตูุงู</th></tr></thead><tbody>${rows}</tbody></table>`;
      } else if (section==='pays'){
        title = `ุชูุตูู ุทุฑู ุงูุฏูุน โข ${r.rangeLabel}`;
        const rows = ['cash','card','credit'].map(k=>{
          const label = payLabel(k);
          return `<tr><td>${label}</td><td>${fmt(r.pays[k]||0)} ${cur}</td></tr>`;
        }).join('');
        content = `<table><thead><tr><th>ุงูุทุฑููุฉ</th><th>ุงููููุฉ</th></tr></thead><tbody>${rows}</tbody></table>`;
      } else if (section==='products'){
        title = `ุชูุตูู ุงูููุชุฌุงุช โข ${r.rangeLabel}`;
        const rows = r.products.map(p=> `<tr><td>${p.name}</td><td>${p.qty||0}</td><td>${fmt(p.total)} ${cur}</td></tr>`).join('');
        content = `<table><thead><tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุงููููุฉ</th></tr></thead><tbody>${rows}</tbody></table>`;
      } else if (section==='suppliers'){
        title = `ููุฎุต ูุนูููุงุช ุงูููุฑุฏูู โข ${r.rangeLabel}`;
        const sumRows = (r.suppliers||[]).map(s=> `<tr><td>${s.supplier}</td><td>${fmt(s.purchases||0)} ${cur}</td><td>${fmt(s.payments||0)} ${cur}</td><td>${fmt(s.balance||0)} ${cur}</td></tr>`).join('');
        const rows = (r.supplierTransactions||[]).map(t=> `<tr><td>${t.supplier}</td><td>${t.type}</td><td>${fmtDate(t.datetime)}</td><td>${fmt(t.amount)} ${cur}</td><td>${t.note||''}</td></tr>`).join('');
        const totals = `<div style="margin:8px 0;font-weight:700">ุฏูู ุงูููุฑุฏูู (ุญุงูู): ${fmt(r.totals.supDebt||0)} ${cur}</div>`;
        content = `${totals}<h2 style="font-size:16px;margin:10px 0 4px">ููุฎุต ุงูููุฑุฏูู (ุงููุชุฑุฉ)</h2><table><thead><tr><th>ุงูููุฑุฏ</th><th>ูุดุชุฑูุงุช</th><th>ูุฏููุน</th><th>ุงููุชุจูู</th></tr></thead><tbody>${sumRows}</tbody></table><h2 style="font-size:16px;margin:10px 0 4px">ุนูููุงุช ุงูููุฑุฏูู</h2><table><thead><tr><th>ุงูููุฑุฏ</th><th>ุงูููุน</th><th>ุงูุชุงุฑูุฎ ูุงูููุช</th><th>ุงููููุฉ</th><th>ููุงุญุธุฉ</th></tr></thead><tbody>${rows}</tbody></table>`;
      }
      win.document.write(`<!doctype html><html lang=\"ar\" dir=\"rtl\"><head><meta charset=\"utf-8\">${style}<title>${title}</title></head><body><h1>${title}</h1>${content}<script>window.onload = ()=> setTimeout(()=> window.print(), 100);<\/script></body></html>`);
      win.document.close();
    }

    function printInvoicesProducts(){
      if (!lastReport) runReport();
      const r = lastReport;
      const cur = store.state.settings.currencySymbol;
      const win = window.open('', '_blank');
      const style = `<style>body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; direction: rtl; padding:16px; color:#0f172a}h1{font-size:18px;margin:0 0 6px}.inv{border:1px solid #e2e8f0;border-radius:10px;padding:10px;margin:10px 0}h2{font-size:14px;margin:0 0 6px}.muted{color:#64748b;font-size:12px}</style>`;
      const blocks = r.sales.slice().reverse().map(s=>{
        const items = s.items.map(i=> i.priceOnly ? `${i.name} โข ${fmt(i.total)} ${cur}` : `${i.name} ร ${i.qty} @ ${fmt(i.price)} ${cur} = ${fmt(i.total)} ${cur}`).join('ุ ');
        const invNo = s.number ? String(s.number).padStart(6,'0') : s.id;
        return `<div class=\"inv\"><h2>ูุงุชูุฑุฉ ${s.type==='sale'?'ุจูุน':'ุชุฑุฌูุน'} โข ${invNo}</h2><div class=\"muted\">${fmtDate(s.date)} โข ุทุฑููุฉ ุงูุฏูุน: ${payLabel(s.paymentMethod)}</div><div>${items}</div><div style=\"margin-top:6px;font-weight:700\">ุงูุฅุฌูุงูู: ${fmt(s.totals.total)} ${cur}</div></div>`;
      }).join('');
      win.document.write(`<!doctype html><html lang=\"ar\" dir=\"rtl\"><head><meta charset=\"utf-8\">${style}<title>ุทุจุงุนุฉ ุงูููุชุฌุงุช ููู ูุงุชูุฑุฉ โข ${r.rangeLabel}</title></head><body><h1>ุงูููุชุฌุงุช ููู ูุงุชูุฑุฉ โข ${r.rangeLabel}</h1>${blocks}<script>window.onload = ()=> setTimeout(()=> window.print(), 100);<\/script></body></html>`);
      win.document.close();
    }

    function printAllInvoices(){
      if (!lastReport) runReport();
      const r = lastReport;
      const cur = store.state.settings.currencySymbol;
      const win = window.open('', '_blank');
      const style = `<style>body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; direction: rtl; padding:16px; color:#0f172a}h1{font-size:18px;margin:0 0 6px}.inv{border:1px solid #e2e8f0;border-radius:10px;padding:10px;margin:10px 0}table{width:100%;border-collapse:collapse}td{border-bottom:1px dashed #e2e8f0;padding:4px 0;font-size:12px}</style>`;
      const blocks = r.sales.slice().reverse().map(s=>{
        const rows = s.items.map(i=>{
          const qtyPart = i.priceOnly ? '' : ` ร ${i.qty}`;
          const unitPart = i.priceOnly ? '' : ` @ ${fmt(i.price)} ${cur}`;
          return `<tr><td>${i.name}${qtyPart}${unitPart}</td><td style=\"text-align:left\">${fmt(i.total)} ${cur}</td></tr>`;
        }).join('');
        const invNo = s.number ? String(s.number).padStart(6,'0') : s.id;
        return `<div class=\"inv\"><div style=\"font-weight:700\">ูุงุชูุฑุฉ ${s.type==='sale'?'ุจูุน':'ุชุฑุฌูุน'} โข ${fmtDate(s.date)} โข ${invNo} โข ${payLabel(s.paymentMethod)}</div><table><tbody>${rows}</tbody><tfoot><tr><td style=\"font-weight:700\">ุงูุฅุฌูุงูู</td><td style=\"text-align:left;font-weight:700\">${fmt(s.totals.total)} ${cur}</td></tr></tfoot></table></div>`;
      }).join('');
      win.document.write(`<!doctype html><html lang=\"ar\" dir=\"rtl\"><head><meta charset=\"utf-8\">${style}<title>ุทุจุงุนุฉ ูู ุงูููุงุชูุฑ โข ${r.rangeLabel}</title></head><body><h1>ูู ุงูููุงุชูุฑ โข ${r.rangeLabel}</h1>${blocks}<script>window.onload = ()=> setTimeout(()=> window.print(), 100);<\/script></body></html>`);
      win.document.close();
    }

    // Dashboard
    function computeNotifications(){
      const notes = [];
      const today = new Date();
      for (const p of store.state.products){
        if (p.priceOnly) continue;
        const st = Number(p.stock||0);
        if (st <= (store.state.settings.lowStockLevel||5)){
          notes.push(`ุชูุจูู ูุฎุฒูู ููุฎูุถ: ${p.name} โข ${st}`);
        }
        if (p.expDate){
          const days = Math.floor((new Date(p.expDate) - today)/(1000*60*60*24));
          if (days < 0) notes.push(`ููุชูู ุงูุตูุงุญูุฉ: ${p.name} (${new Date(p.expDate).toLocaleDateString('ar-LY')})`);
          else if (days <= 30) notes.push(`ูุฑุจ ุงูุชูุงุก ุงูุตูุงุญูุฉ ุฎูุงู ${days} ููู: ${p.name}`);
        }
      }
      return notes;
    }

    function updateDash(){
      // today
      const today = new Date();
      const sameDay = (iso)=>{ const d=new Date(iso); return d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate(); };
      const sales = store.state.sales.filter(s=> sameDay(s.date));
      const expenses = store.state.expenses.filter(e=> sameDay(e.date));
      const totalSales = sales.reduce((a,s)=> a + Number(s.totals.total||0), 0);
      const cost = sales.reduce((a,s)=> a + Number(s.totals.cost||0), 0);
      const exp = expenses.reduce((a,e)=> a + Number(e.amount||0), 0);
      const profit = (totalSales - cost) - exp;
      $('#dash-today-sales').textContent = currency(totalSales);
      $('#dash-today-exp').textContent = currency(exp);
      $('#dash-today-profit').textContent = currency(profit);
      // low stock
      const lvl = store.state.settings.lowStockLevel||5;
      const low = store.state.products.filter(p=> !p.priceOnly && Number(p.stock||0) <= lvl);
      const ul = $('#dash-low-stock'); ul.innerHTML='';
      if (low.length===0) ul.innerHTML = '<li class="text-slate-400">ูุง ุชูุฌุฏ ุชูุจููุงุช</li>';
      for (const p of low){ const li = document.createElement('li'); li.textContent = `${p.name} โข ${p.stock ?? 0}`; ul.appendChild(li); }
      // Notifications panel
      const notes = computeNotifications();
      const unl = $('#dash-notifications'); unl.innerHTML='';
      if (notes.length===0) unl.innerHTML = '<li class="text-slate-400">ูุง ุฅุดุนุงุฑุงุช</li>';
      for (const n of notes){ const li=document.createElement('li'); li.textContent=n; unl.appendChild(li); }
      const notiCount = $('#noti-count'); if (notiCount) notiCount.textContent = String(notes.length);
      // DB panel
      renderDbPanel();
    }

    // Export/Import
    function exportBackup(isAuto=false){
      const data = JSON.stringify(store.state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const storeName = store.state?.settings?.storeName || 'ุงูุณุงุญู ููููุงุฏ ุงูุบุฐุงุฆูุฉ';
      const name = fileSafe(storeName) + '-' + tsFile() + (isAuto ? '-auto' : '') + '-backup.json';
      const a = document.createElement('a'); a.href=url; a.download= name; a.click(); URL.revokeObjectURL(url);
      if (isAuto){
        store.state.settings.autoBackup.last = nowISO();
        store.save();
      }
    }

    function importBackup(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try {
          const data = JSON.parse(reader.result);
          if (!data || typeof data !== 'object') throw new Error('ููู ุบูุฑ ุตุงูุญ');
          store.state = Object.assign(defaultState(), data);
          store.save();
          initUI();
          alert('ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ');
        } catch(e){ alert('ูุดู ุงูุงุณุชูุฑุงุฏ: '+e.message); }
      };
      reader.readAsText(file);
    }

    // DB panel helpers
    function renderDbPanel(){
      // status
      $('#db-status').textContent = db.db ? 'ูุชุตู' : 'ุบูุฑ ูุชุตู';
      $('#db-last-test').textContent = store.state.meta?.lastDbTest ? fmtDate(store.state.meta.lastDbTest) : '--';
      const ver = 'v' + APP_VERSION;
      const hdrVer = $('#app-version'); if (hdrVer) hdrVer.textContent = ver;
      const dashVer = $('#app-version-dash'); if (dashVer) dashVer.textContent = ver;
      const footVer = $('#footer-version'); if (footVer) footVer.textContent = ver;
      // Update DB name label if present
      const dbNameEl = document.getElementById('db-name'); if (dbNameEl) dbNameEl.textContent = getDbName();
    }

    async function testDatabase(){
      try {
        // Save a small tick into meta and persist
        store.state.meta = store.state.meta || {};
        store.state.meta.lastDbTest = nowISO();
        await store.save();
        renderDbPanel();
        alert('ุชู ุงุฎุชุจุงุฑ ุงููุงุนุฏุฉ ูุญูุธ ุงูุชุบููุฑ ุจูุฌุงุญ');
      } catch(e){
        alert('ูุดู ุงูุงุฎุชุจุงุฑ: '+ (e?.message||e));
      }
    }

    function clearDatabase(){
      if (!confirm('ุณูุชู ูุณุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ ูุฌููุน ุงูุจูุงูุงุช ุงููุฎุฒููุฉ (IndexedDB + ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ). ูู ุฃูุช ูุชุฃูุฏุ')) return;
      const req = indexedDB.deleteDatabase(getDbName());
      req.onsuccess = ()=>{
        try { localStorage.removeItem(store.key); } catch(e){}
        alert('ุชู ูุณุญ ุงููุงุนุฏุฉ. ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู.');
        location.reload();
      };
      req.onerror = ()=> alert('ูุดู ูุณุญ ุงููุงุนุฏุฉ');
    }

    function openApkGuide(){
      const steps = [
        'ุงูุฎูุงุฑ 1 (ููุตู ุจู): ุชุญููู ุงููููุน ุฅูู PWA ุซู ุฅูุดุงุก TWA ุนุจุฑ Android Studio ูุฑุจุท ุงููููุน ูุชุทุจูู.',
        'ุงูุฎูุงุฑ 2: ุงุณุชุฎุฏุงู Capacitor ุฃู Cordova ูุชุบููู ุงููููุน ูู WebView ูุฅูุชุงุฌ APK.',
        'ุงูุฎุทูุงุช ุงููุฎุชุตุฑุฉ: ุฅุนุฏุงุฏ Android Studio โข ุฅูุดุงุก ูุดุฑูุน Capacitor โข ูุณุฎ index.html ุฏุงุฎู www โข ุชุดุบูู npx cap add android ุซู npx cap open android โข ุจูุงุก APK Release.',
        'ุจุฏูู ููุฏ: ูููู ุงุณุชุนูุงู ููุตุงุช ูุซู PWABuilder ูุชุญููู ุงููููุน ูุจุงุดุฑุฉ ุฅูู ุชุทุจูู.'
      ];
      $('#modal-title').textContent = 'ุฅุฑุดุงุฏุงุช ุฅูุดุงุก APK';
      const body = $('#modal-body');
      body.innerHTML = '';
      const p = document.createElement('p'); p.className='text-sm text-slate-600'; p.textContent = 'ูุง ูููู ุฅูุดุงุก ููู APK ูุจุงุดุฑุฉ ูู ุงููุชุตูุญุ ููู ููููู ุชุบููู ูุฐู ุงูุตูุญุฉ ูุชุทุจูู ุฃูุฏุฑููุฏ ุนุจุฑ ุฅุญุฏู ุงูุทุฑู ุงูุชุงููุฉ:'; body.appendChild(p);
      const ul = document.createElement('ul'); ul.className='list-disc pr-5 text-sm text-slate-700 space-y-1';
      steps.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
      body.appendChild(ul);
      const note = document.createElement('div'); note.className='text-xs text-slate-500'; note.textContent = 'ูุตูุญุฉ: ูุนูู HTTPS ูุงุณู ูุทุงูุ ูุฃุถู ุฃููููุฉ ูุงุณู ุงูุชุทุจูู ูู ุงูุฅุนุฏุงุฏุงุช ูุจู ุงูุชุบููู.'; body.appendChild(note);
      $('#modal').classList.remove('hidden');
      $('#modal-ok').textContent = 'ุฅุบูุงู';
      $('#modal-cancel').classList.add('hidden');
      const close = ()=>{ $('#modal').classList.add('hidden'); $('#modal-ok').textContent='ููุงูู'; $('#modal-cancel').classList.remove('hidden'); };
      $('#modal-ok').onclick = close; $('#modal-cancel').onclick = close;
    }

    function showInstallGuide(){
      $('#modal-title').textContent = 'ุชุซุจูุช ุงูุชุทุจูู ุนูู ุงูููุจููุชุฑ/ุงููุงุชู';
      const body = $('#modal-body'); body.innerHTML='';
      const p = document.createElement('p'); p.className='text-sm text-slate-700'; p.textContent = 'ุฅุฐุง ูู ูุธูุฑ ูุฑุจุน ุงูุชุซุจูุช ุงูุชููุงุฆูุ ููููู ุชุซุจูุช ุงูุชุทุจูู ูุฏูููุง ููุง ููู:'; body.appendChild(p);
      const ul = document.createElement('ul'); ul.className='list-disc pr-5 text-sm text-slate-700 space-y-1';
      const platform = navigator.userAgent.toLowerCase();
      const hints = [];
      hints.push('ุณุทุญ ุงูููุชุจ (Chrome/Edge): ูู ุดุฑูุท ุงูุนููุงู ุงุถุบุท ุฃููููุฉ ุงูุชุซุจูุช โค ุฃู ูู ุงููุงุฆูุฉ โฎ ุงุฎุชุฑ Install App.');
      hints.push('Android (Chrome): ูู ุงููุงุฆูุฉ โฎ ุงุฎุชุฑ ุฅุถุงูุฉ ุฅูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ ุฃู ุชุซุจูุช ุงูุชุทุจูู.');
      hints.push('iOS (Safari): ูู ุฒุฑ ุงููุดุงุฑูุฉ โขโ ุงุฎุชุฑ ุฅุถุงูุฉ ุฅูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ.');
      hints.push('ุจุนุฏ ุงูุชุซุจูุช ุณูุนูู ุงูุชุทุจูู ูู ูุงูุฐุฉ ูุณุชููุฉ ูุจูุง ุฅูุชุฑูุช.');
      hints.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
      body.appendChild(ul);
      $('#modal').classList.remove('hidden');
      $('#modal-ok').textContent = 'ุฅุบูุงู';
      $('#modal-cancel').classList.add('hidden');
      const close = ()=>{ $('#modal').classList.add('hidden'); $('#modal-ok').textContent='ููุงูู'; $('#modal-cancel').classList.remove('hidden'); };
      $('#modal-ok').onclick = close; $('#modal-cancel').onclick = close;
    }

    function openNotificationsModal(){
      const notes = computeNotifications();
      $('#modal-title').textContent = 'ุงูุฅุดุนุงุฑุงุช';
      const body = $('#modal-body'); body.innerHTML='';
      if (notes.length===0){ const p=document.createElement('p'); p.textContent='ูุง ุฅุดุนุงุฑุงุช ุญุงููุฉ'; p.className='text-sm text-slate-600'; body.appendChild(p); }
      else {
        const ul=document.createElement('ul'); ul.className='list-disc pr-5 text-sm text-slate-700 space-y-1';
        for (const n of notes){ const li=document.createElement('li'); li.textContent=n; ul.appendChild(li); }
        body.appendChild(ul);
      }
      $('#modal').classList.remove('hidden');
      $('#modal-ok').textContent = 'ุฅุบูุงู';
      $('#modal-cancel').classList.add('hidden');
      const close = ()=>{ $('#modal').classList.add('hidden'); $('#modal-ok').textContent='ููุงูู'; $('#modal-cancel').classList.remove('hidden'); };
      $('#modal-ok').onclick = close; $('#modal-cancel').onclick = close;
    }

    // Event bindings and init
    let deferredInstallPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredInstallPrompt = e; const b=document.getElementById('btn-install'); if (b) b.classList.remove('hidden'); });
    window.addEventListener('appinstalled', ()=>{ const b=document.getElementById('btn-install'); if (b) b.classList.add('hidden'); });

    function initUI(){
      // Ensure original layout (show main buttons, no FAB)
      document.body.classList.remove('hide-main');
      // Tabs
      $$('.tab-btn').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));
      // Home grid buttons
      $$('#home-grid .home-btn').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));
      showTab('home');

      // POS
      $$('.cat-btn').forEach(btn=> btn.addEventListener('click', ()=>{ posFilter.cat = btn.dataset.cat; $('#pos-current-cat').textContent = posFilter.cat==='all' ? 'ุนุฑุถ ุงููู' : ('ุงูุชุตููู: '+posFilter.cat); renderPOSProducts(); }));
      $('#pos-search').addEventListener('input', renderPOSProducts);
      $('#btn-clear-cart').addEventListener('click', ()=>{ cart=[]; renderCart(); });
      $('#btn-checkout').addEventListener('click', checkout);
      $('#btn-print-invoice').addEventListener('click', printProformaFromCart);
      $('#btn-save-invoice-pdf').addEventListener('click', printProformaFromCart);
      $$('.pay-method').forEach(r=> r.addEventListener('change', ()=>{
        const val = ($('.pay-method:checked')||{}).value;
        $('#credit-area').classList.toggle('hidden', val!=='credit');
        $('#card-area').classList.toggle('hidden', val!=='card');
        if (val==='credit') refreshCreditSelect('#credit-customer-select');
      }));

      // Returns
      $$('.ret-cat-btn').forEach(btn=> btn.addEventListener('click', ()=>{ retFilter.cat = btn.dataset.cat; $('#ret-current-cat').textContent = retFilter.cat==='all' ? 'ุนุฑุถ ุงููู' : ('ุงูุชุตููู: '+retFilter.cat); renderReturnProducts(); }));
      $('#return-code').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const p = findProductByCode(e.target.value); if(p){ addToReturn(p); e.target.value=''; } else alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุฌ ุจูุฐุง ุงูููุฏ'); }});
      $('#btn-clear-return').addEventListener('click', ()=>{ retCart=[]; renderRetCart(); });
      $('#btn-process-return').addEventListener('click', processReturn);
      $$('.ret-pay-method').forEach(r=> r.addEventListener('change', ()=>{
        const val = ($('.ret-pay-method:checked')||{}).value;
        $('#ret-credit-area').classList.toggle('hidden', val!=='credit');
        $('#ret-card-area').classList.toggle('hidden', val!=='card');
        if (val==='credit') refreshCreditSelect('#ret-credit-customer-select');
      }));

      // Inventory
      $('#btn-add-sample').addEventListener('click', addSampleProducts);
      $('#btn-new-product').addEventListener('click', ()=> openProductModal());
      $('#inv-search').addEventListener('input', renderInventory);
      $('#inv-cat-filter').addEventListener('change', renderInventory);
      $('#btn-export').addEventListener('click', exportBackup);
      const importFileInput = document.getElementById('import-file');
      const btnImport = document.getElementById('btn-import');
      if (btnImport && importFileInput){
        btnImport.addEventListener('click', ()=> importFileInput.click());
        importFileInput.addEventListener('change', (e)=>{ if (e.target.files[0]) importBackup(e.target.files[0]); e.target.value=''; });
      }

      // Customers
      $('#btn-new-customer').addEventListener('click', ()=>{
        promptModal('ุนููู ุฌุฏูุฏ', 'ุฃุฏุฎู ุจูุงูุงุช ุงูุนููู', {fields:[{id:'name',label:'ุงูุงุณู',type:'text'},{id:'phone',label:'ุงููุงุชู',type:'text'}]}).then(data=>{
          if (!data) return; const name=(data.name||'').trim(); if (!name) return alert('ุงูุงุณู ูุทููุจ');
          const c={ id:newId('c'), name, phone:(data.phone||'').trim(), balance:0, updatedAt: nowISO(), transactions:[] };
          store.state.customers.push(c); store.save(); renderCustomers();
        });
      });
      $('#cust-search').addEventListener('input', renderCustomers);

      // Suppliers
      const newSupBtn = $('#btn-new-supplier'); if (newSupBtn) newSupBtn.addEventListener('click', addSupplier);
      const supSearch = $('#sup-search'); if (supSearch) supSearch.addEventListener('input', renderSuppliers);

      // Expenses
      $('#btn-add-expense').addEventListener('click', ()=>{
        const amount = Number($('#exp-amount').value||0); const note = $('#exp-note').value||'';
        if (!(amount>0)) return alert('ุฃุฏุฎู ูุจูุบูุง ุตุญูุญูุง');
        store.state.expenses.push({ id:newId('e'), amount, note, date: nowISO() });
        store.save(); $('#exp-amount').value=''; $('#exp-note').value=''; renderExpenses(); updateDash();
      });

      // Reports
      $('#rep-type').addEventListener('change', ()=>{
        const t = $('#rep-type').value;
        $('#rep-date-wrap').classList.toggle('hidden', t!=='daily');
        $('#rep-month-wrap').classList.toggle('hidden', t!=='monthly');
        $('#rep-year-wrap').classList.toggle('hidden', t!=='yearly');
      });
      $('#btn-run-report').addEventListener('click', runReport);
      $('#btn-export-csv').addEventListener('click', exportReportCSV);
      $('#btn-print-report').addEventListener('click', printReport);
      $('#btn-save-report-pdf').addEventListener('click', printReport);
      $('#btn-print-transactions').addEventListener('click', ()=> printReportSection('transactions'));
      $('#btn-print-pays').addEventListener('click', ()=> printReportSection('pays'));
      $('#btn-print-products').addEventListener('click', ()=> printReportSection('products'));
      $('#btn-print-suppliers').addEventListener('click', ()=> printReportSection('suppliers'));
      $('#btn-print-invoices-products').addEventListener('click', printInvoicesProducts);
      $('#btn-print-all-invoices').addEventListener('click', printAllInvoices);

      // Settings / Dashboard
      $('#btn-save-settings').addEventListener('click', ()=>{
        const s = store.state.settings;
        s.storeName = $('#set-store-name').value || s.storeName;
        s.currencySymbol = $('#set-curr-symbol').value || s.currencySymbol;
        s.currency = $('#set-currency').value || s.currency;
        s.allowNegativeStock = $('#set-negative-stock').checked;
        s.enable3D = $('#set-enable-3d').checked;
        const partnersText = (document.getElementById('set-partners')?.value || '').split('\n').map(x=>x.trim()).filter(Boolean);
        s.partners = partnersText;
        store.save(); refreshSettings(); refreshHeader(); renderPOSProducts(); updateDash();
        apply3DSetting();
        alert('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช');
      });
      // Auth & Permissions
      $('#btn-save-auth').addEventListener('click', ()=>{
        const s = store.state.settings;
        s.adminPassword = $('#set-admin-pass').value || s.adminPassword;
        // ุญูุธ ูุงุฆูุฉ ุงูููุธููู ูู textarea ุจุตูุบุฉ: ุงูุงุณู,ูููุฉ ุงููุฑูุฑ ููู ุณุทุฑ
        const empArea = document.getElementById('set-employees');
        const employees = [];
        if (empArea && empArea.value.trim()){
          empArea.value.split(/\n+/).forEach(line=>{
            const raw = line.trim();
            if (!raw) return;
            const parts = raw.split(/[,ุ:]+/); // ููุตู ุจุงูู , ุฃู ุ ุฃู :
            const name = (parts[0]||'').trim();
            const pass = (parts[1]||'').trim();
            if (!name || !pass) return;
            employees.push({ name, password: pass });
          });
        }
        s.employees = employees;
        s.permissions.hideSettings = $('#perm-hide-settings').checked;
        s.permissions.hideExport = $('#perm-hide-export').checked;
        s.permissions.hideDeletes = $('#perm-hide-deletes').checked;
        s.permissions.hideProductsManage = $('#perm-hide-products-manage').checked;
        s.permissions.hideReports = $('#perm-hide-reports').checked;
        s.permissions.hideDashboard = $('#perm-hide-dashboard').checked;
        s.permissions.hideSuppliers = $('#perm-hide-suppliers').checked;
        store.save();
        applyPermissionsToUI();
        alert('ุชู ุญูุธ ุตูุงุญูุงุช ุงููุณุชุฎุฏููู ูุงูููุธููู');
      });
      $('#btn-switch-user').addEventListener('click', ()=> loginDialog());
      $('#btn-logout').addEventListener('click', ()=> loginDialog());
      // Sync
      $('#btn-sync-now').addEventListener('click', syncNow);
      $('#set-auto-sync').addEventListener('change', ()=>{ store.state.settings.autoSync.enabled = $('#set-auto-sync').checked; scheduleAutoSync(); store.save(); });
      $('#set-sync-interval').addEventListener('change', ()=>{ store.state.settings.autoSync.intervalMin = Math.max(1, Number($('#set-sync-interval').value||15)); scheduleAutoSync(); store.save(); });
      $('#set-sync-endpoint').addEventListener('change', ()=>{ store.state.settings.autoSync.endpoint = $('#set-sync-endpoint').value; store.save(); });
      $('#set-sync-email').addEventListener('change', ()=>{ store.state.settings.autoSync.email = $('#set-sync-email').value; store.save(); });
      // Auto backup settings
      const autoBackupChk = $('#set-auto-backup');
      const backupInterval = $('#set-backup-interval');
      if (autoBackupChk) autoBackupChk.addEventListener('change', ()=>{ store.state.settings.autoBackup.enabled = !!autoBackupChk.checked; scheduleAutoBackup(); store.save(); });
      if (backupInterval) backupInterval.addEventListener('change', ()=>{ store.state.settings.autoBackup.intervalHours = Math.max(1, Number(backupInterval.value||24)); scheduleAutoBackup(); store.save(); });

      // DB/Backup panel buttons
      $('#btn-db-test').addEventListener('click', testDatabase);
      $('#btn-db-clear').addEventListener('click', clearDatabase);
      $('#btn-export-dash').addEventListener('click', exportBackup);
      const importDashInput = document.getElementById('import-file-dash');
      const btnImportDash = document.getElementById('btn-import-dash');
      if (btnImportDash && importDashInput){
        btnImportDash.addEventListener('click', ()=> importDashInput.click());
        importDashInput.addEventListener('change', (e)=>{ if (e.target.files[0]) importBackup(e.target.files[0]); e.target.value=''; });
      }
      $('#btn-apk-help').addEventListener('click', openApkGuide);
      $('#btn-open-notifications').addEventListener('click', openNotificationsModal);
      // Install PWA on desktop (show even without prompt; fallback guide)
      const btnInstall = document.getElementById('btn-install');
      const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone;
      // ููุจูู ุฒุฑ ุงูุชุซุจูุช ููุงุณุชุฎุฏุงู ุงูุงุฎุชูุงุฑูุ ููู ุงูุชุซุจูุช ุงูุฃุณุงุณู ูุชู ูู ูุงุฆูุฉ ุงููุชุตูุญ (ุงูุซูุงุซ ููุงุท)
      if (btnInstall){
        if (!isStandalone) btnInstall.classList.remove('hidden');
        btnInstall.addEventListener('click', ()=>{
          showInstallGuide();
        });
      }

      // Theme toggle
      $('#btn-toggle-theme').addEventListener('click', ()=>{
        const cur = localStorage.getItem('sahel-theme') || 'modern-theme';
        const next = cur==='futuristic-2030' ? 'modern-theme' : 'futuristic-2030';
        setTheme(next);
      });
      // Back button to home
      $('#btn-back-home').addEventListener('click', ()=> showTab('home'));

      // Keyboard shortcuts: F5 to checkout on POS
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'F5'){
          // prevent browser refresh and attempt checkout only when POS tab is visible
          const posTab = document.getElementById('tab-pos');
          if (posTab && !posTab.classList.contains('hidden')){
            e.preventDefault();
            try { checkout(); } catch(err){}
          }
        }
      });

      renderDbPanel();

      refreshSettings();
      renderInventory();
      renderCustomers();
      renderSuppliers();
      renderExpenses();
      renderPOSProducts();
      renderReturnProducts();
      renderCart(); renderRetCart();
      updateDash();
      refreshCreditSelect('#credit-customer-select');
      refreshCreditSelect('#ret-credit-customer-select');
      // Initialize payment UI visibility
      const payValInit = ($('.pay-method:checked')||{}).value; if (payValInit){ $('#credit-area').classList.toggle('hidden', payValInit!=='credit'); $('#card-area').classList.toggle('hidden', payValInit!=='card'); }
      const retPayValInit = ($('.ret-pay-method:checked')||{}).value; if (retPayValInit){ $('#ret-credit-area').classList.toggle('hidden', retPayValInit!=='credit'); $('#ret-card-area').classList.toggle('hidden', retPayValInit!=='card'); }

      // Apply 3D mode per settings
      apply3DSetting();

      // Default report date/month/year
      const today = new Date();
      $('#rep-date').valueAsDate = today;
      $('#rep-month').value = today.toISOString().slice(0,7);
      const yEl = $('#rep-year'); if (yEl) yEl.value = String(today.getFullYear());
      runReport();
    }

    function refreshCreditSelect(sel){
      const s = $(sel); if (!s) return;
      s.innerHTML = '<option value="">-- ุงุฎุชุฑ ุนููู --</option>';
      for (const c of store.state.customers){ const op=document.createElement('option'); op.value=c.id; op.textContent=c.name + (c.balance? ` (${currency(c.balance)})`:'' ); s.appendChild(op); }
    }

    function refreshSettings(){
      const s = store.state.settings;
      $('#set-store-name').value = s.storeName;
      $('#set-curr-symbol').value = s.currencySymbol;
      $('#set-currency').value = s.currency;
      $('#set-negative-stock').checked = !!s.allowNegativeStock;
      const partnersArea = document.getElementById('set-partners');
      if (partnersArea) partnersArea.value = (s.partners||[]).join('\n');
      // auth
      $('#set-admin-pass').value = s.adminPassword||'';
      const empArea = document.getElementById('set-employees');
      if (empArea){
        const lines = (s.employees||[]).map(e=> `${e.name||''},${e.password||''}`.trim()).filter(Boolean);
        empArea.value = lines.join('\n');
      }
      $('#perm-hide-settings').checked = !!s.permissions?.hideSettings;
      $('#perm-hide-export').checked = !!s.permissions?.hideExport;
      $('#perm-hide-deletes').checked = !!s.permissions?.hideDeletes;
      $('#perm-hide-products-manage').checked = !!s.permissions?.hideProductsManage;
      $('#perm-hide-reports').checked = !!s.permissions?.hideReports;
      $('#perm-hide-dashboard').checked = !!s.permissions?.hideDashboard;
      $('#perm-hide-suppliers').checked = !!s.permissions?.hideSuppliers;
      // sync
      $('#set-sync-endpoint').value = s.autoSync?.endpoint||'';
      $('#set-sync-email').value = s.autoSync?.email||'';
      $('#set-auto-sync').checked = !!s.autoSync?.enabled;
      $('#set-sync-interval').value = s.autoSync?.intervalMin||15;
      $('#sync-last').textContent = s.autoSync?.last ? fmtDate(s.autoSync.last) : 'ูุง ููุฌุฏ';
      $('#sync-status').textContent = s.autoSync?.status || '-';
      // auto backup
      const autoBackupStatus = document.getElementById('auto-backup-status');
      if (autoBackupStatus){
        const st = s.autoBackup?.last ? ('ุขุฎุฑ ูุณุฎุฉ: ' + fmtDate(s.autoBackup.last)) : 'ูู ูุชู ุฅูุดุงุก ูุณุฎุฉ ุจุนุฏ';
        autoBackupStatus.textContent = s.autoBackup?.enabled ? st : 'ุบูุฑ ููุนู';
      }
      const autoBackupChk = document.getElementById('set-auto-backup'); if (autoBackupChk) autoBackupChk.checked = !!s.autoBackup?.enabled;
      const backupInterval = document.getElementById('set-backup-interval'); if (backupInterval) backupInterval.value = s.autoBackup?.intervalHours||24;
      // set versions in UI too
      const ver = 'v' + APP_VERSION;
      const hdrVer = $('#app-version'); if (hdrVer) hdrVer.textContent = ver;
      const dashVer = $('#app-version-dash'); if (dashVer) dashVer.textContent = ver;
      const footVer = $('#footer-version'); if (footVer) footVer.textContent = ver;
      // 3D checkbox
      const chk3d = document.getElementById('set-enable-3d'); if (chk3d) chk3d.checked = !!s.enable3D;
      applyPermissionsToUI();
      refreshRoleBadge();
    }

    // Icons and UI decoration helpers
    function svg(name){
      const base = 'class="w-4 h-4"';
      switch(name){
        case 'theme': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 100 18c4.97 0 9-4.03 9-9 0-1.1-.9-2-2-2-3.87 0-7-3.13-7-7 0-1.1-.9-2-2-2z"/></svg>`;
        case 'pos': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v3H3V7zm0 5h7v5H5a2 2 0 01-2-2v-3zm9 0h9v3a2 2 0 01-2 2h-7v-5z"/></svg>`;
        case 'returns': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M4 7h10a6 6 0 110 12H8v-2h6a4 4 0 100-8H4l3-3-1.4-1.4L2 7l3.6 3.4L7 9l-3-2z"/></svg>`;
        case 'inventory': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M3 7l9-4 9 4v10l-9 4-9-4V7zm9 2l-7-3v7l7 3 7-3V6l-7 3z"/></svg>`;
        case 'customers': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M16 11a4 4 0 10-8 0 4 4 0 008 0zm-6 5a6 6 0 00-6 6h2a4 4 0 018 0h2a6 6 0 00-6-6z"/></svg>`;
        case 'suppliers': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M3 7h18v2H3V7zm2 4h14v8H5v-8zm2 2v4h10v-4H7z"/></svg>`;
        case 'expenses': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 100 18 9 9 0 000-18zm1 13h-2v-2h2v2zm0-4h-2V7h2v5z"/></svg>`;
        case 'reports': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2zm3 12h2V7H8v8zm4 0h2V9h-2v6zm4 0h2v-4h-2v4z"/></svg>`;
        case 'dashboard': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3zm10 0h8v5h-8V3zM3 13h5v8H3v-8zm7 5h11v3H10v-3z"/></svg>`;
        case 'print': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M6 9V3h12v6h2a2 2 0 012 2v5h-4v5H8v-5H4v-5a2 2 0 012-2h0zm2-4v2h8V5H8zm0 10v3h8v-3H8z"/></svg>`;
        case 'pdf': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h7l5 5v13a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2zm7 1.5V7h3.5L13 3.5zM8 13h3a2 2 0 000-4H8v4zm0-3h3a1 1 0 010 2H8v-2zm6-1h4v1h-3v1h2v1h-2v2h-1v-5zm-8 1H5v4h1v-1h1a1.5 1.5 0 000-3H6v-0z"/></svg>`;
        case 'checkout': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h2l3 9h8l3-7H9"/><circle cx="9" cy="20" r="2"/><circle cx="17" cy="20" r="2"/></svg>`;
        case 'clear': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M6 19a2 2 0 002 2h8a2 2 0 002-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
        case 'delete': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M6 7h12l-1 12a2 2 0 01-2 2H9a2 2 0 01-2-2L6 7zm3-3h6l1 1h4v2H4V5h4l1-1z"/></svg>`;
        case 'edit': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
        case 'stock': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l4 4H8l4-4zm0 18l-4-4h8l-4 4zM3 12l4-4v8l-4-4zm18 0l-4 4V8l4 4z"/></svg>`;
        case 'add': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V6h2v5h5v2h-5v5h-2v-5H6v-2h5z"/></svg>`;
        case 'backup': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a7 7 0 00-7 7H3l3.89 3.89L10.78 10H8a5 5 0 115 5v2a7 7 0 00-1-14z"/></svg>`;
        case 'restore': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M12 6v6l4 2-.75 1.86L11 13V6h1zM4 12a8 8 0 1116 0 8 8 0 01-16 0z"/></svg>`;
        case 'eye': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>`;
        case 'cash': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v12H3V6zm2 2v8h14V8H5zm3 1a4 4 0 108 0 4 4 0 00-8 0z"/></svg>`;
        case 'card': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M2 5h20v14H2V5zm2 2v2h16V7H4zm0 4v6h16v-6H4z"/></svg>`;
        case 'all': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h6v6H4V5zm0 8h6v6H4v-6zm10-8h6v6h-6V5zm0 8h6v6h-6v-6z"/></svg>`;
        case 'drink': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10l-1 9a5 5 0 01-4 4.9V22h-2v-6.1A5 5 0 018 11L7 2zm0 2l.6 5h8.8l.6-5H7z"/></svg>`;
        case 'juice': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M6 3h12l-1 5H7L6 3zm2 7h8l-1.5 11h-5L8 10z"/></svg>`;
        case 'choco': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10v20H7V2zm2 2v4h2V4H9zm4 0v4h2V4h-2zM9 10v4h2v-4H9zm4 0v4h2v-4h-2zM9 16v4h2v-4H9zm4 0v4h2v-4h-2z"/></svg>`;
        case 'food': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h2v20H6V2zm5 6a4 4 0 118 0v14h-2v-7h-4v7h-2V8z"/></svg>`;
        case 'legume': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c3 0 7 3 7 7s-4 9-7 9-7-5-7-9 4-7 7-7z"/></svg>`;
        case 'candy': return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a4 4 0 014 4v1h1a3 3 0 110 6h-1v1a4 4 0 11-8 0v-1H7a3 3 0 110-6h1V8a4 4 0 014-4zm-2 5v6a2 2 0 104 0V9a2 2 0 10-4 0z"/></svg>`;
        default: return `<svg ${base} viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>`;
      }
    }

    function setIcon(el, iconSvg, label){ if(!el || el.dataset.iconized) return; el.innerHTML = `<span class="inline-flex items-center gap-1.5">${iconSvg}<span>${label}</span></span>`; el.dataset.iconized = '1'; if (label) el.title = label; }

    function addIcons(){
      // Nav tabs
      const navIcons = { home:'dashboard', pos:'pos', returns:'returns', inventory:'inventory', customers:'customers', suppliers:'suppliers', expenses:'expenses', reports:'reports', dashboard:'dashboard' };
      const navLabels = { home:'ุงูุฑุฆูุณูุฉ', pos:'ููุทุฉ ุงูุจูุน', returns:'ููุทุฉ ุงูุชุฑุฌูุน', inventory:'ุงููุฎุฒูู', customers:'ุงูุนููุงุก', suppliers:'ุงูููุฑุฏูู', expenses:'ุงููุตุฑููุงุช', reports:'ุงูุชูุงุฑูุฑ', dashboard:'ููุญุฉ ุงูุชุญูู' };
      // Theme button
      const themeBtn = document.querySelector('#btn-toggle-theme'); if (themeBtn) setIcon(themeBtn, svg('theme'), 'ุงููุธูุฑ');
      Object.keys(navIcons).forEach(k=>{ const btn = document.querySelector(`.tab-btn[data-tab="${k}"]`); if(btn) setIcon(btn, svg(navIcons[k]), navLabels[k]); });
      // Home grid icons + 3D tilt
      document.querySelectorAll('#home-grid .home-btn').forEach(el=>{
        const ic = el.dataset.icon || 'dashboard';
        const label = el.dataset.label || el.textContent.trim();
        setIcon(el, svg(ic), label);
        el.classList.add('tilt');
      });
      // POS action buttons
      const act = [
        ['#btn-clear-cart','clear','ุฅูุฑุงุบ'],
        ['#btn-print-invoice','print','ุทุจุงุนุฉ ูุงุชูุฑุฉ'],
        ['#btn-save-invoice-pdf','pdf','ุญูุธ PDF'],
        ['#btn-checkout','checkout','ุชุญุตูู (F5)']
      ];
      act.forEach(([sel,ic,label])=>{ const el=document.querySelector(sel); if(el){ setIcon(el, svg(ic), label); el.classList.add('tilt'); } });
      // Return buttons
      const ract = [
        ['#btn-clear-return','clear','ุฅูุฑุงุบ'],
        ['#btn-process-return','checkout','ุชุฑุฌูุน']
      ]; ract.forEach(([sel,ic,label])=>{ const el=document.querySelector(sel); if(el){ setIcon(el, svg(ic), label); el.classList.add('tilt'); } });
      // Inventory top buttons
      [['#btn-add-sample','add','ุฅุถุงูุฉ ุนููุงุช'],['#btn-new-product','add','ููุชุฌ ุฌุฏูุฏ']].forEach(([sel,ic,label])=>{ const el=document.querySelector(sel); if(el){ setIcon(el, svg(ic), label); el.classList.add('tilt'); } });
      // Reports toolbar
      [['#btn-run-report','reports','ุนุฑุถ ุงูุชูุฑูุฑ'],['#btn-export-csv','pdf','ุชุตุฏูุฑ CSV'],['#btn-print-report','print','ุทุจุงุนุฉ'],['#btn-save-report-pdf','pdf','ุญูุธ PDF'],['#btn-print-invoices-products','print','ุทุจุงุนุฉ ุงูููุชุฌุงุช ููู ูุงุชูุฑุฉ'],['#btn-print-all-invoices','print','ุทุจุงุนุฉ ูู ุงูููุงุชูุฑ'],['#btn-print-suppliers','print','ุทุจุงุนุฉ ุงูููุฑุฏูู']].forEach(([sel,ic,label])=>{ const el=document.querySelector(sel); if(el){ setIcon(el, svg(ic), label); el.classList.add('tilt'); } });
      // Dashboard DB/Backup
      [['#btn-db-test','reports','ุงุฎุชุจุงุฑ ุงููุงุนุฏุฉ'],['#btn-db-clear','delete','ูุณุญ ุงููุงุนุฏุฉ'],['#btn-export-dash','pdf','ูุณุฎ ุงุญุชูุงุทู']].forEach(([sel,ic,label])=>{ const el=document.querySelector(sel); if(el){ setIcon(el, svg(ic), label); el.classList.add('tilt'); } });
      // Category buttons (POS/Returns)
      const catIconMap = { all:'all', 'ูุดุฑูุจุงุช':'drink', 'ุนุตุงุฆุฑ':'juice', 'ุดูููุงุชุฉ':'choco', 'ููุงุฏ ุบุฐุงุฆูุฉ':'food', 'ุจููููุงุช':'legume', 'ููุชุฌุงุช ุตุบูุฑุฉ':'candy' };
      document.querySelectorAll('.cat-btn, .ret-cat-btn').forEach(b=>{ const lab=b.textContent.trim(); const ic = catIconMap[b.dataset.cat] || catIconMap[lab] || 'all'; setIcon(b, svg(ic), lab); b.classList.add('tilt'); });
      // Decorate supplier pay buttons if any
      document.querySelectorAll('button.paysup').forEach(b=>{ setIcon(b, svg('cash'), b.textContent.trim()||'ุฏูุน'); });
    }

    function decorateDynamicButtons(){
      document.querySelectorAll('button.edit').forEach(b=>{ setIcon(b, svg('edit'), b.textContent.trim()||'ุชุนุฏูู'); });
      document.querySelectorAll('button.del').forEach(b=>{ setIcon(b, svg('delete'), b.textContent.trim()||'ุญุฐู'); });
      document.querySelectorAll('button.stock').forEach(b=>{ setIcon(b, svg('stock'), b.textContent.trim()||'ุชุนุฏูู ุงููููุฉ'); });
      document.querySelectorAll('button.pay').forEach(b=>{ setIcon(b, svg('cash'), b.textContent.trim()||'ุฏูุน ุงูุฏูู'); });
      document.querySelectorAll('button.view').forEach(b=>{ setIcon(b, svg('eye'), b.textContent.trim()||'ุชูุงุตูู'); });
      document.querySelectorAll('button.addp').forEach(b=>{ setIcon(b, svg('add'), b.textContent.trim()||'ุนูููุฉ'); });
      document.querySelectorAll('button.rep-print').forEach(b=>{ setIcon(b, svg('print'), b.textContent.trim()||'ุทุจุงุนุฉ'); });
      document.querySelectorAll('button.rep-pdf').forEach(b=>{ setIcon(b, svg('pdf'), b.textContent.trim()||'PDF'); });
    }

    function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=> fn.apply(null,args), wait); }; }
    function setupIconObserver(){ const obs = new MutationObserver(debounce(()=>{ decorateDynamicButtons(); apply3DTilt(); }, 200)); obs.observe(document.body, { childList:true, subtree:true }); decorateDynamicButtons(); }

    // Theme setter
    function setTheme(name){
      document.body.classList.remove('modern-theme','futuristic-2030');
      document.body.classList.add(name);
      localStorage.setItem('sahel-theme', name);
    }

    // Roles & permissions
    function applyPermissionsToUI(){
      const user = store.state.meta?.currentUser || { role:'admin' };
      // ุฃุฒู ุฌููุน ุฃุตูุงู ุงูุตูุงุญูุงุช ุฃููุงู ุญุชู ูุง ุชุจูู ูููุฏ ูุฏููุฉ ูุนูุงูุฉ
      document.body.classList.remove(
        'role-admin',
        'role-employee',
        'lock-settings',
        'hide-export',
        'hide-deletes',
        'hide-products-manage',
        'hide-db',
        'hide-reports',
        'hide-dashboard',
        'hide-suppliers'
      );

      if (user.role === 'admin'){
        // ุงููุฏูุฑ: ูู ุดูุก ูุชุงุญ
        document.body.classList.add('role-admin');
      } else {
        // ุงูููุธู: ุชุทุจููู ุงููููุฏ ุญุณุจ ูุง ุญุฏุฏู ุงููุฏูุฑ ูู ููุญุฉ ุงูุชุญูู
        document.body.classList.add('role-employee');
        const p = store.state.settings.permissions || {};
        if (p.hideSettings) document.body.classList.add('lock-settings');
        if (p.hideExport) document.body.classList.add('hide-export');
        if (p.hideDeletes) document.body.classList.add('hide-deletes');
        if (p.hideProductsManage) document.body.classList.add('hide-products-manage');
        if (p.hideReports) document.body.classList.add('hide-reports');
        if (p.hideDashboard) document.body.classList.add('hide-dashboard');
        if (p.hideSuppliers) document.body.classList.add('hide-suppliers');
      }
    }

    function refreshRoleBadge(){
      const badge = document.getElementById('role-badge');
      const btnLogout = document.getElementById('btn-logout');
      const user = store.state.meta?.currentUser || { role:'admin' };
      if (!badge || !btnLogout) return;
      badge.classList.remove('hidden');
      btnLogout.classList.remove('hidden');
      if (user.role === 'admin'){
        badge.textContent = 'ูุฏูุฑ';
      } else {
        badge.textContent = 'ููุธู';
      }
    }

    function loginDialog(){
      const s = store.state.settings;
      promptModal('ุชุณุฌูู ุงูุฏุฎูู', 'ุงุฎุชุฑ ููุน ุงููุณุชุฎุฏู ูุฃุฏุฎู ูููุฉ ุงููุฑูุฑ', {
        fields:[
          {id:'role',label:'ููุน ุงููุณุชุฎุฏู',type:'select',options:['ูุฏูุฑ','ููุธู'],value:'ูุฏูุฑ'},
          {id:'name',label:'ุงุณู ุงููุณุชุฎุฏู',type:'text',placeholder:'ูุซุงู: ุฃุญูุฏ'},
          {id:'pass',label:'ูููุฉ ุงููุฑูุฑ',type:'password',placeholder:'โขโขโขโขโขโข'}
        ]
      }).then(async data=>{
        if (!data) return;
        const roleSel = data.role === 'ููุธู' ? 'employee' : 'admin';
        const name = (data.name||'').trim() || (roleSel==='admin'?'ุงููุฏูุฑ':'ููุธู');
        const pass = data.pass||'';
        if (roleSel === 'admin'){
          if (pass !== (s.adminPassword||'0000')){ alert('ูููุฉ ูุฑูุฑ ุงููุฏูุฑ ุบูุฑ ุตุญูุญุฉ'); return; }
          store.state.meta.currentUser = { role:'admin', name };
        } else {
          const employees = s.employees || [];
          const emp = employees.find(e=> e.name === name && e.password === pass);
          if (!emp){ alert('ุงุณู ุงูููุธู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ'); return; }
          store.state.meta.currentUser = { role:'employee', name };
        }
        await store.save();
        applyPermissionsToUI();
        refreshRoleBadge();
      });
    }

    // First run onboarding: require email + admin password + employee PIN
    function firstRunOnboarding(){
      // Run if never onboarded OR lock password not set
      if (store.state.meta?.onboarded && store.state.settings?.appLockHash) return Promise.resolve(true);
      return new Promise(resolve=>{
        $('#modal-title').textContent = 'ุชููุฆุฉ ุฃูู ูุฑุฉ';
        const body = $('#modal-body'); body.innerHTML='';
        const wrap = document.createElement('div'); wrap.className='space-y-2';
        wrap.innerHTML = `
          <div>
            <label class="text-sm text-slate-600">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ูููุฒุงููุฉ ุงูุณุญุงุจูุฉ)</label>
            <input id="onb-email" type="email" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="you@example.com" />
          </div>
          <div>
            <label class="text-sm text-slate-600">ูููุฉ ูุฑูุฑ ุงูููู (ุณุชุทูุจ ุนูุฏ ูุชุญ ุงูุชุทุจูู)</label>
            <input id="onb-pass" type="password" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ุงุฎุชุฑ ูููุฉ ูุฑูุฑ ูููุฉ" />
          </div>`;
        body.appendChild(wrap);
        $('#modal').classList.remove('hidden');
        $('#modal-cancel').onclick = ()=>{ $('#modal').classList.add('hidden'); resolve(true); };
        $('#modal-ok').onclick = async ()=>{
          const email = $('#onb-email').value.trim();
          const pass = $('#onb-pass').value.trim();
          if (email){ store.state.settings.autoSync.email = email; }
          if (pass){ store.state.settings.appLockHash = await sha256(pass); }
          if (!store.state.meta.onboarded) store.state.meta.onboarded = nowISO();
          await store.save();
          $('#modal').classList.add('hidden');
          resolve(true);
        };
      });
    }

    // Simple auto sync using webhook endpoint
    let syncTimer = null;
    async function syncNow(){
      const s = store.state.settings.autoSync || {};
      const endpoint = s.endpoint || '';
      if (!endpoint){ alert('ุฃุฏุฎู ุฑุงุจุท ุงููุฒุงููุฉ ุฃูููุง'); return; }
      try{
        const payload = { ts: nowISO(), store: store.state.settings.storeName, version: APP_VERSION, email: s.email||'', data: store.state };
        await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        store.state.settings.autoSync.last = nowISO();
        store.state.settings.autoSync.status = 'ุชูุช ุงููุฒุงููุฉ ุจูุฌุงุญ';
        store.save(); refreshSettings();
      } catch(e){
        store.state.settings.autoSync.status = 'ูุดู: ' + (e?.message||e);
        store.save(); refreshSettings();
      }
    }
    function scheduleAutoSync(){
      const cfg = store.state.settings.autoSync || {};
      if (syncTimer) clearInterval(syncTimer);
      if (!cfg.enabled) return;
      const ms = Math.max(1, Number(cfg.intervalMin||15)) * 60000;
      syncTimer = setInterval(syncNow, ms);
    }

    // Auto backup
    let backupTimer = null;
    function scheduleAutoBackup(){
      const cfg = store.state.settings.autoBackup || {};
      if (backupTimer) clearInterval(backupTimer);
      if (!cfg.enabled) return;
      const ms = Math.max(1, Number(cfg.intervalHours||24)) * 3600000;
      backupTimer = setInterval(()=>{ try{ exportBackup(true); }catch(e){} }, ms);
    }

    function exportBackup(isAuto=false){
      const data = JSON.stringify(store.state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const storeName = store.state?.settings?.storeName || 'ุงูุณุงุญู ููููุงุฏ ุงูุบุฐุงุฆูุฉ';
      const name = fileSafe(storeName) + '-' + tsFile() + (isAuto ? '-auto' : '') + '-backup.json';
      const a = document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
      if (isAuto){
        store.state.settings.autoBackup.last = nowISO();
        store.save();
      }
    }

    // Floating Actions (FAB)
    function setFab(actions){
      const fab = document.getElementById('fab');
      const list = document.getElementById('fab-list');
      if (!fab || !list) return;
      list.innerHTML = '';
      if (!actions || actions.length===0){ fab.classList.add('hidden'); return; }
      fab.classList.remove('hidden');
      actions.forEach(a=>{
        const btn = document.createElement('button');
        btn.className = 'fab-item';
        btn.title = a.label;
        btn.innerHTML = a.icon || 'โข';
        btn.addEventListener('click', ()=>{ try{ a.fn && a.fn(); }finally{ fab.classList.remove('open'); } });
        list.appendChild(btn);
      });
    }
    function toggleFab(){ const fab=document.getElementById('fab'); if (fab) fab.classList.toggle('open'); }
    function closeFab(){ const fab=document.getElementById('fab'); if (fab) fab.classList.remove('open'); }
    function buildFabForTab(name){
      // Disable FAB actions and hide it
      setFab([]);
    }

    // 3D Tilt helpers
    function handleTilt(e){
      const el = e.currentTarget;
      const rect = el.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const dx = (e.clientX - cx) / (rect.width/2);
      const dy = (e.clientY - cy) / (rect.height/2);
      const max = 10; // deg
      const rx = (-dy * max).toFixed(2);
      const ry = (dx * max).toFixed(2);
      el.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
    }
    function resetTilt(e){ e.currentTarget.style.transform = 'rotateX(0) rotateY(0)'; }
    function apply3DTilt(){
      document.body.classList.add('three-d');
      document.querySelectorAll('.tilt').forEach(el=>{
        el.removeEventListener('mousemove', handleTilt);
        el.removeEventListener('mouseleave', resetTilt);
        el.addEventListener('mousemove', handleTilt);
        el.addEventListener('mouseleave', resetTilt);
      });
    }

    function disable3DTilt(){
      document.body.classList.remove('three-d');
      document.querySelectorAll('.tilt').forEach(el=>{
        el.style.transform = 'none';
        el.removeEventListener('mousemove', handleTilt);
        el.removeEventListener('mouseleave', resetTilt);
      });
    }

    function apply3DSetting(){
      if (store.state?.settings?.enable3D){
        apply3DTilt();
      } else {
        disable3DTilt();
      }
    }

    // App Lock flow
    async function appLockFlow(){
      const hash = store.state?.settings?.appLockHash || null;
      const overlay = document.getElementById('lock-overlay');
      if (!overlay) return true;
      if (!hash){ return true; }
      return await new Promise(resolve=>{
        overlay.classList.remove('hidden');
        const desc = document.getElementById('lock-desc'); if (desc) desc.textContent = 'ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ููุชุญ ุงูุชุทุจูู';
        const input = document.getElementById('lock-pass'); const msg = document.getElementById('lock-msg');
        const ok = document.getElementById('lock-ok'); const cancel = document.getElementById('lock-cancel');
        const forgot = document.getElementById('lock-forgot');
        const submit = async ()=>{
          const val = (input.value||'').trim();
          const valHash = await sha256(val);
          if (valHash === hash){ overlay.classList.add('hidden'); resolve(true); }
          else { msg.textContent = 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ'; }
        };
        ok.onclick = submit;
        cancel.onclick = ()=>{ msg.textContent = ''; input.value=''; };
        input.onkeydown = (e)=>{ if (e.key==='Enter') submit(); };
        if (forgot){
          forgot.onclick = ()=>{
            // ุฅุธูุงุฑ ูุงูุฐุฉ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ููู ุดุงุดุฉ ุงูููู
            const prevMsg = msg.textContent || '';
            overlay.classList.add('hidden');
            promptModal('ุชุบููุฑ ูููุฉ ูุฑูุฑ ุงูููู', 'ุฃุฏุฎู ูููุฉ ูุฑูุฑ ุงููุฏูุฑ ุซู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ููููู', {
              fields:[
                {id:'admin',label:'ูููุฉ ูุฑูุฑ ุงููุฏูุฑ',type:'password',placeholder:'โขโขโขโขโขโข'},
                {id:'newpass',label:'ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ููููู',type:'password',placeholder:'โขโขโขโขโขโข'}
              ]
            }).then(async data=>{
              // ุจุนุฏ ุฅุบูุงู ุงููุงูุฐุฉ ูุนูุฏ ุฅุธูุงุฑ ุทุจูุฉ ุงูููู
              overlay.classList.remove('hidden');
              if (!data){
                msg.textContent = prevMsg;
                return;
              }
              const s = store.state.settings;
              const adminOk = (data.admin||'') === (s.adminPassword||'0000');
              if (!adminOk){ msg.textContent = 'ูููุฉ ูุฑูุฑ ุงููุฏูุฑ ุบูุฑ ุตุญูุญุฉ'; return; }
              const np = (data.newpass||'').trim();
              if (!np){ msg.textContent = 'ุฃุฏุฎู ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ ููููู'; return; }
              s.appLockHash = await sha256(np);
              await store.save();
              msg.textContent = 'ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑุ ุงุณุชุฎุฏููุง ุงูุขู ููุชุญ ุงูุชุทุจูู.';
              input.value = '';
            });
          };
        }
        setTimeout(()=> input.focus(), 50);
      });
    }

    // Init
    (async function(){
      await store.load();
      // Apply saved theme (default modern/original)
      const savedTheme = localStorage.getItem('sahel-theme') || 'modern-theme';
      setTheme(savedTheme);
      refreshHeader();
      // First run onboarding (email + lock setup)
      const okOnb = await firstRunOnboarding();
      if (!okOnb) return;
      // App lock before UI
      await appLockFlow();
      initUI();
      // ุจุนุฏ ุงูุชููุฆุฉุ ุทุจูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู (ูุฏูุฑ/ููุธู)
      applyPermissionsToUI();
      refreshRoleBadge();
      scheduleAutoSync();
      scheduleAutoBackup();
      // Register service worker for offline support
      if ('serviceWorker' in navigator){
        try { await navigator.serviceWorker.register('sw.js'); } catch (e) { console.warn('SW register failed', e); }
      }
      // FAB setup disabled (keep layout consistent)
      const fabRoot = document.getElementById('fab'); if (fabRoot) fabRoot.classList.add('hidden');
      try { addIcons(); setupIconObserver(); decorateDynamicButtons(); apply3DTilt(); } catch(e){}
      const disc = document.getElementById('cart-discount-input'); if (disc) disc.addEventListener('input', renderCartTotals);
    })();
  </script>
</body>
</html>